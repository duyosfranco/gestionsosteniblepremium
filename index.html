<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Gesti√≥n Sostenible ‚Äî Inicio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="prefetch" href="clientes-firestore.html" as="document" />
  <link rel="prefetch" href="retiros.html" as="document" />
  <link rel="prefetch" href="finanzas.html" as="document" />
  <link rel="prefetch" href="usuarios.html" as="document" />
  <link rel="prefetch" href="configuracion.html" as="document" />
  <link rel="prefetch" href="temas.html" as="document" />
  <style>
    :root{
      --ink:#0D2B3D; --ink2:#0b1f2a;
      --bg:#f3f7fb; --bg2:#fbfdff;
      --card:#fff; --overlay:rgba(15,51,70,.55);
      --accent:#1DBF73; --accent2:#16a062; --accent3:#13a660; --accent-soft:#E8FFF5;
      --muted:#6b7c8a; --line:#e6eef5;
      --nav:#0f3346; --nav2:#0b2a3b;
      --nav-contrast:#ffffff; --nav-contrast-soft:rgba(255,255,255,.85); --nav-contrast-muted:rgba(255,255,255,.65);
      --shadow:0 16px 45px rgba(13,43,61,.18);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Helvetica,Arial,sans-serif;
      color:var(--ink2);
      background:radial-gradient(circle at top left, rgba(29,191,115,.08), transparent 42%),
                 radial-gradient(circle at bottom right, rgba(15,51,70,.08), transparent 45%),
                 linear-gradient(180deg,var(--bg) 0%, var(--bg2) 100%);
      text-rendering:optimizeLegibility;
      -webkit-font-smoothing:antialiased;
    }
    @media (prefers-reduced-motion: reduce){
      *,*::before,*::after{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important}
    }
    .hidden{display:none}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}

    /* Landing + login (unauthenticated view) */
    body:not(.app-ready) #appView{display:none!important}
    body:not(.app-ready) #loginView{display:block!important}
    body.app-ready #loginView{display:none!important}

    .login-panel{display:none}
    body.login-open .login-panel{display:grid}
    body.login-open .landing-shell{display:none}

    .login-wrap{background:var(--bg);color:var(--ink2);min-height:100vh}
    .landing-shell{min-height:100vh;display:flex;flex-direction:column;gap:50px}
    .landing-hero{background:linear-gradient(180deg,#0d2b3d 0%,#0a3f57 80%);color:#eaf7ff;position:relative;overflow:hidden}
    .landing-hero::after{content:"";position:absolute;inset:0;background:radial-gradient(900px 460px at -10% -20%,rgba(23,195,123,.22),transparent 60%),radial-gradient(700px 520px at 110% 10%,rgba(12,114,150,.24),transparent 60%);pointer-events:none}
    .hero-wrap{max-width:1120px;margin:0 auto;padding:38px 20px 60px;position:relative;z-index:1}
    .site-header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:12px 0 18px}
    .nav-links{display:flex;gap:16px;align-items:center;font-weight:600;color:#d9f1ff}
    .nav-links a{padding:9px 12px;border-radius:10px;text-decoration:none;color:inherit}
    .nav-links a:hover{background:rgba(255,255,255,.12)}
    .hero-grid{display:grid;grid-template-columns:1.05fr .95fr;gap:30px;align-items:center;margin-top:12px}
    .login-pill{display:inline-flex;align-items:center;gap:6px;padding:7px 12px;border-radius:999px;font-weight:700;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.28);color:#ccecff;font-size:13px;margin-bottom:8px}
    .landing-hero h1{margin:6px 0 12px;font-size:38px;line-height:1.16;letter-spacing:.01em;color:#fff}
    .landing-hero p{margin:0 0 16px;color:rgba(234,247,255,.9);max-width:620px}
    .login-cta{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0 14px}
    .login-cta .btn{height:46px;padding:0 18px}
    .laptop-mock{position:relative;justify-self:end}
    .laptop-top{background:#0e1c25;border-radius:16px 16px 0 0;padding:12px;border:1px solid #0c3f53;box-shadow:0 22px 38px rgba(0,0,0,.5);position:relative;overflow:hidden}
    .laptop-camera{width:10px;height:10px;border-radius:50%;background:#1a3242;margin:0 auto 8px}
    .laptop-screen{display:block;width:100%;border-radius:8px;border:1px solid #183e55;box-shadow:inset 0 0 12px rgba(0,0,0,.35)}
    .laptop-top::after{content:"";position:absolute;inset:0;background:linear-gradient(120deg,rgba(255,255,255,.16),rgba(255,255,255,.03) 60%,transparent 100%);mix-blend-mode:overlay;pointer-events:none}
    .laptop-base{width:92%;height:18px;margin:0 auto;border-radius:0 0 16px 16px;background:linear-gradient(90deg,#8f9ea7,#cad3da,#8f9ea7);box-shadow:0 12px 26px rgba(0,0,0,.38)}
    .feature-section{padding:64px 0;background:var(--bg)}
    .wrap{max-width:1120px;margin:0 auto;padding:0 20px}
    .kicker{color:var(--accent2);font-weight:800;letter-spacing:.4px;margin-bottom:.4rem}
    .feature-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-top:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 12px 26px rgba(13,43,61,.08)}
    .card h3{margin:.2rem 0 .4rem}
    .card p{margin:0;color:var(--muted);line-height:1.5}
    .steps{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-top:14px}
    .step .num{width:36px;height:36px;border-radius:999px;background:#e8f3fa;color:#0f5270;display:grid;place-items:center;font-weight:800;margin-bottom:8px}
    .cta-final{background:linear-gradient(180deg,#0f3346 0%,#0b2a3b 100%);color:#dff4ff;border-top:1px solid #0e4156}
    .cta-final .card{background:#0f364a;border-color:#16536a;color:#dff4ff}
    .cta-final p{color:#cfeaf3}

    .login-panel{min-height:90vh;place-items:center;padding:40px 18px;background:linear-gradient(160deg,#0a2433 0%,#0c3a54 60%,#0a4a67 100%);color:#eaf7ff}
    .login-card{width:min(430px,92vw);background:rgba(9,31,43,.9);border:1px solid rgba(93,172,199,.45);border-radius:18px;padding:26px 26px 22px;box-shadow:0 18px 38px rgba(0,0,0,.35);backdrop-filter:blur(4px);text-align:center}
    .brand{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:12px;font-weight:800;letter-spacing:.01em;--brand-logo-aspect:1}
    .brand .logo,
    .side-brand .logo{
      min-width:38px;
      width:var(--brand-logo-width,42px);
      height:var(--brand-logo-height,42px);
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--accent-soft);
      color:var(--accent2);
      font-weight:900;
      position:relative;
      overflow:hidden;
      padding:4px;
      transition:background .2s ease, box-shadow .2s ease, width .2s ease, height .2s ease;
    }
    .brand .logo span,
    .side-brand .logo span{transition:opacity .2s ease}
    .brand .logo-img,
    .side-brand .logo-img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:none;
    }
    .brand[data-has-logo="true"] .logo,
    .side-brand[data-has-logo="true"] .logo{
      background:transparent;
      padding:0;
      box-shadow:none;
    }
    .brand[data-has-logo="true"] .logo span,
    .side-brand[data-has-logo="true"] .logo span{display:none}
    .brand[data-has-logo="true"] .logo-img,
    .side-brand[data-has-logo="true"] .logo-img{
      display:block;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,.18));
    }
    .brand[data-logo-shape="wide"] .logo,
    .side-brand[data-logo-shape="wide"] .logo{
      --brand-logo-width:clamp(56px, calc(42px * var(--brand-logo-aspect,1.4)), 160px);
    }
    .brand[data-logo-shape="tall"] .logo,
    .side-brand[data-logo-shape="tall"] .logo{
      --brand-logo-height:clamp(42px, calc(42px / clamp(.45, var(--brand-logo-aspect,1), 5)), 72px);
    }
    .login-card h1{margin:.2rem 0 10px;font-size:24px;letter-spacing:.01em}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .login-card input{
      flex:1 1 180px; min-width:0; height:44px; border-radius:12px;
      border:1px solid rgba(93,172,199,.45); background:rgba(7,38,53,.8); color:#e6f6ff; padding:0 14px;
      transition:border .2s ease,box-shadow .2s ease,transform .2s ease;
    }
    .login-card input:focus-visible{border-color:#7dd7ff;box-shadow:0 0 0 3px rgba(98,196,228,.35);transform:translateY(-1px)}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      border:0; border-radius:12px; cursor:pointer; font-weight:600;
      height:44px; padding:0 16px; transition:transform .18s ease,box-shadow .18s ease,background .18s ease;
      touch-action:manipulation;
    }
    .btn.primary{background:var(--accent); color:#fff; box-shadow:0 10px 20px rgba(29,191,115,.24)}
    .btn.primary:hover{background:var(--accent2); transform:translateY(-1px); box-shadow:0 12px 24px rgba(22,160,98,.28)}
    .btn.primary:active{background:var(--accent3); transform:translateY(0);}
    .btn.ghost{background:rgba(255,255,255,.06); color:#d6f1ff; border:1px solid rgba(125,215,255,.45)}
    .btn.ghost:hover{background:rgba(255,255,255,.12); border-color:#7dd7ff; transform:translateY(-1px)}
    .btn.ghost:active{transform:translateY(0)}
    .msg{margin-top:10px; min-height:18px; color:#dfefff; font-size:14px}
    .hint{margin-top:6px; font-size:13px; color:rgba(223,239,255,.85); line-height:1.45}

    /* App layout */
    .app{display:grid; grid-template-columns:260px 1fr; min-height:100vh; position:relative}
    .sidebar{
      background:linear-gradient(190deg,var(--nav) 0%, var(--nav2) 100%);
      color:var(--nav-contrast-soft); padding:20px 16px; border-right:1px solid rgba(9,25,34,.72);
      transition:transform .25s ease, box-shadow .25s ease;
    }
    .side-brand{display:flex;align-items:center;gap:12px;margin-bottom:16px;position:relative;--brand-logo-aspect:1}
    .side-brand .name{font-weight:800;letter-spacing:.01em;color:var(--nav-contrast)}
    .nav{display:grid;gap:8px;margin-top:18px}
    .nav a{
      display:flex;gap:12px;align-items:center;
      padding:11px 14px;border-radius:12px;color:var(--nav-contrast-muted);border:1px solid transparent;text-decoration:none;font-weight:500;
      transition:background .2s ease,border-color .2s ease,transform .2s ease;
    }
    .nav a span[aria-hidden="true"]{font-size:18px}
    .nav a:hover{background:rgba(15,66,87,.65);border-color:rgba(30,107,136,.45);transform:translateX(3px)}
    .nav a.active{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.35);color:var(--nav-contrast);box-shadow:0 10px 22px rgba(0,0,0,.18)}
    .bottom{margin-top:auto;padding-top:18px;border-top:1px solid rgba(255,255,255,.08)}
    .logout{width:100%;gap:10px;background:rgba(255,255,255,.12);color:var(--nav-contrast)}
    .logout:hover{background:rgba(255,255,255,.18)}

    .main{display:flex;flex-direction:column;min-height:100vh;background:linear-gradient(180deg,rgba(255,255,255,.78) 0%,rgba(255,255,255,.96) 100%)}
    .header{
      position:sticky;top:0;z-index:2;
      background:rgba(255,255,255,.92); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
      padding:14px 20px; display:flex; align-items:center; gap:18px; justify-content:space-between;
    }
    .header-main{display:flex;align-items:center;gap:12px;flex:1 1 auto;min-width:0}
    .header .title-wrap{display:grid;gap:4px;align-content:center}
    .header .title{font-weight:800; color:var(--ink);font-size:20px;letter-spacing:.01em}
    .header .subtitle{color:var(--muted);font-size:14px}
    .menu-toggle{
      display:none; align-items:center; justify-content:center;
      width:42px; height:42px; border-radius:11px; border:1px solid #d5e4ef;
      background:#fff; color:var(--nav); cursor:pointer; transition:background .2s ease,transform .2s ease;
    }
    .menu-toggle:hover{background:#eef6fb}
    .menu-toggle:focus-visible{outline:3px solid rgba(16,113,150,.25);}

    .viewer{flex:1 1 auto; position:relative; background:linear-gradient(180deg,#f6fafc 0%,#ffffff 60%);}
    .viewer iframe{
      position:absolute; inset:0; width:100%; height:100%;
      border:0; background:transparent; opacity:0; transition:opacity .24s ease;
    }
    .viewer iframe.loaded{opacity:1}
    .viewer-loading{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg,rgba(255,255,255,.85) 0%,rgba(255,255,255,.94) 60%);
      color:var(--muted); font-size:14px; gap:14px; text-align:left; padding:0 28px;
      transition:opacity .25s ease; opacity:1; visibility:visible;
    }
    .viewer-loading.hidden{opacity:0;pointer-events:none;visibility:hidden}
    .viewer-error{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      gap:18px; padding:0 28px; text-align:left;
      background:linear-gradient(180deg,rgba(255,255,255,.9) 0%,rgba(255,255,255,.98) 65%);
      color:var(--ink2); border-top:1px solid rgba(15,51,70,.08);
      transition:opacity .25s ease; opacity:0; visibility:hidden;
    }
    .viewer-error:not(.hidden){opacity:1;visibility:visible}
    .viewer-error .icon{font-size:28px;display:grid;place-items:center;width:48px;height:48px;border-radius:16px;background:rgba(255,90,95,.14);color:#d93025;box-shadow:0 12px 28px rgba(217,48,37,.18)}
    .viewer-error h3{margin:0 0 6px;font-size:18px;color:var(--ink)}
    .viewer-error p{margin:0 0 12px;color:var(--muted);font-size:14px;line-height:1.45;max-width:380px}
    .viewer-error .actions{display:flex;flex-wrap:wrap;gap:10px}
    .spinner{width:32px;height:32px;border-radius:50%;border:3px solid rgba(16,113,150,.18);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .btn.outline{
      background:transparent;
      color:var(--nav);
      border:1px solid rgba(16,113,150,.25);
      box-shadow:none;
    }
    .btn.outline:hover{background:rgba(16,113,150,.08);}
    .btn.outline:focus-visible{outline:3px solid rgba(16,113,150,.25);}

    .home-wrap{padding:28px 24px 40px;display:grid;gap:28px;content-visibility:auto;contain-intrinsic-size:780px;}
    .home-hero{display:grid;gap:10px;max-width:760px}
    .home-hero h2{margin:0;color:var(--ink);font-size:30px;letter-spacing:.01em}
    .home-hero p{margin:0;color:var(--muted);font-size:16px;line-height:1.5}
    .home-metrics{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));}
    .metric-card{display:flex;gap:14px;align-items:flex-start;padding:18px 20px;border-radius:18px;border:1px solid var(--line);background:linear-gradient(180deg,#ffffff 0%,#f9fcff 100%);box-shadow:0 12px 30px rgba(13,43,61,.12);min-height:112px;position:relative;overflow:hidden}
    .metric-icon{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background:rgba(16,113,150,.12);color:var(--nav);font-size:22px;flex-shrink:0}
    .metric-content{display:grid;gap:6px;align-content:start}
    .metric-label{font-size:13px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);font-weight:600}
    .metric-value{font-size:28px;font-weight:800;color:var(--ink)}
    .metric-meta{font-size:13px;color:var(--muted);line-height:1.4}
    .session-chip{margin-left:auto;display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.86);box-shadow:0 12px 28px rgba(13,43,61,.12);min-width:0}
    .session-chip.hidden{display:none}
    .session-role{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--accent2);background:rgba(29,191,115,.12);padding:2px 10px;border-radius:999px}
    .session-email{font-size:14px;color:var(--muted);white-space:nowrap;max-width:220px;overflow:hidden;text-overflow:ellipsis}
    .session-chip[data-role="admin"] .session-role{background:rgba(16,113,150,.12);color:var(--nav)}
    .session-chip[data-role="guest"] .session-role{background:rgba(15,51,70,.12);color:var(--muted)}
    .nav-backdrop{display:none}

    /* Responsive refinements */
    @media (max-width: 1180px){
      .home-hero h2{font-size:28px}
    }

    @media (max-width: 1024px){
      .app{grid-template-columns:1fr}
      .sidebar{position:fixed;inset:0 auto 0 0;width:280px;height:100vh;transform:translateX(-105%);box-shadow:0 20px 50px rgba(13,43,61,.45);z-index:5}
      body.nav-open .sidebar{transform:translateX(0);}
      .nav-backdrop{display:block;position:fixed;inset:0;background:var(--overlay);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:4}
      body.nav-open .nav-backdrop{opacity:1;pointer-events:auto}
      body.nav-open{overflow:hidden}
      .menu-toggle{display:inline-flex}
      .main{min-height:100vh}
      .hero-grid{grid-template-columns:1fr}
      .laptop-mock{max-width:520px;justify-self:center}
    }

    @media (max-width: 768px){
      .site-header{flex-wrap:wrap}
      .nav-links{flex-wrap:wrap}
    }

    @media (max-width:640px){
      .header{padding:12px 16px}
      .home-wrap{padding:24px 18px;contain-intrinsic-size:880px;}
      .metric-card{flex-direction:column;align-items:flex-start}
      .metric-icon{width:40px;height:40px;font-size:20px}
      .metric-value{font-size:24px}
      .session-chip{padding:8px 12px}
      .landing-hero h1{font-size:32px}
      .nav-links{gap:10px}
      .login-card{padding:20px}
    }
    
    /* ========================================
       EXECUTIVE COMMAND CENTER STYLES
       Mobile-First Responsive Design
       Integraci√≥n con Sistema de Temas Actual
    ======================================== */
    
    :root {
        /* COLORES DIN√ÅMICOS - SE LEEN DE LA APLICACI√ìN EXISTENTE */
        --primary-color: var(--accent, #1DBF73);
        --secondary-color: var(--accent2, #16a062);
        --accent-color: var(--accent, #1DBF73);
        --accent-dark: #16a062;
        --danger-color: #e74c3c;
        --warning-color: var(--muted, #6b7c8a);
        --success-color: var(--accent, #1DBF73);
        --muted-color: var(--muted, #6b7c8a);
        
        /* COLORES DE FONDO - LEER DE VARIABLES EXISTENTES */
        --text-primary: var(--ink, #0D2B3D);
        --text-secondary: var(--muted, #6b7c8a);
        --bg-primary: var(--bg, #f3f7fb);
        --bg-secondary: var(--bg2, #fbfdff);
        --border-color: var(--line, #e6eef5);
        
        /* COMPONENTES DE DISE√ëO */
        --shadow-light: 0 2px 8px rgba(0,0,0,0.1);
        --shadow-medium: 0 4px 16px rgba(0,0,0,0.15);
        --border-radius: 12px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* ========================================
       DASHBOARD CONTAINER PRINCIPAL
    ======================================== */
    .executive-dashboard {
        background: var(--bg-primary);
        min-height: 100vh;
        padding: 1rem;
        transition: var(--transition);
    }
    
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-light);
    }
    
    .dashboard-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }
    
    .dashboard-subtitle {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin: 0.25rem 0 0 0;
    }
    
    /* ========================================
       ALERTS BANNER
    ======================================== */
    .alerts-banner {
        background: linear-gradient(135deg, var(--accent-soft, #E8FFF5), var(--bg-secondary));
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-light);
    }
    
    .alert-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color);
        animation: fadeInUp 0.5s ease;
    }
    
    .alert-item:last-child {
        border-bottom: none;
    }
    
    .alert-icon {
        width: 20px;
        height: 20px;
        color: var(--warning-color);
        flex-shrink: 0;
    }
    
    .alert-content {
        flex: 1;
    }
    
    .alert-title {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.9rem;
        margin: 0 0 0.25rem 0;
    }
    
    .alert-time {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    
    /* ========================================
       PERIOD SELECTOR
    ======================================== */
    .period-selector {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 2rem;
        padding: 0.5rem;
        background: var(--bg-secondary);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-light);
        overflow-x: auto;
    }
    
    .period-btn {
        padding: 0.75rem 1.5rem;
        border: 1px solid var(--border-color);
        background: var(--bg-primary);
        color: var(--text-secondary);
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--transition);
        white-space: nowrap;
        font-weight: 500;
    }
    
    .period-btn:hover {
        border-color: var(--accent-color);
        color: var(--accent-color);
    }
    
    .period-btn.active {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
        box-shadow: 0 2px 8px rgba(29, 191, 115, 0.25);
    }
    
    /* ========================================
       KPI CARDS GRID
    ======================================== */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .kpi-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--shadow-light);
        transition: var(--transition);
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .kpi-card:hover {
        box-shadow: var(--shadow-medium);
        transform: translateY(-2px);
    }
    
    .kpi-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }
    
    .kpi-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }
    
    .kpi-icon {
        width: 40px;
        height: 40px;
        background: var(--accent-soft);
        color: var(--accent-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    
    .kpi-metrics {
        display: flex;
        align-items: baseline;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .kpi-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1;
    }
    
    .kpi-change {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 999px;
    }
    
    .kpi-change.positive {
        color: var(--success-color);
        background: rgba(29, 191, 115, 0.1);
    }
    
    .kpi-change.negative {
        color: var(--danger-color);
        background: rgba(231, 76, 60, 0.1);
    }
    
    .kpi-chart-container {
        height: 120px;
        margin-top: 1rem;
        position: relative;
    }
    
    .kpi-chart {
        width: 100%;
        height: 100%;
    }
    
    /* ========================================
       AI INTELLIGENCE PANEL
    ======================================== */
    .ai-intelligence-panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-light);
    }
    
    .ai-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .ai-panel-header h3 {
        margin: 0;
        color: var(--text-primary);
        font-size: 1.3rem;
        font-weight: 700;
    }
    
    .ai-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--muted-color);
    }
    
    .status-dot.active {
        background: var(--success-color);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .ai-content {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }
    
    .ai-section h4 {
        margin: 0 0 1rem 0;
        color: var(--text-primary);
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    /* Predictions Grid */
    .predictions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
    }
    
    .prediction-item {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.3s ease;
    }
    
    .prediction-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }
    
    .prediction-icon {
        width: 48px;
        height: 48px;
        background: var(--accent-soft);
        color: var(--accent-color);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    
    .prediction-content {
        flex: 1;
    }
    
    .prediction-title {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }
    
    .prediction-value {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }
    
    .prediction-trend {
        font-size: 0.9rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 999px;
    }
    
    .prediction-trend.up {
        color: var(--success-color);
        background: rgba(29, 191, 115, 0.1);
    }
    
    .prediction-trend.down {
        color: var(--danger-color);
        background: rgba(231, 76, 60, 0.1);
    }
    
    .prediction-confidence {
        font-size: 0.8rem;
        color: var(--muted-color);
    }
    
    /* Recommendations List */
    .recommendations-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .recommendation-item {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        transition: all 0.3s ease;
    }
    
    .recommendation-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }
    
    .recommendation-item.priority-high {
        border-left: 4px solid var(--danger-color);
    }
    
    .recommendation-item.priority-medium {
        border-left: 4px solid #f39c12;
    }
    
    .recommendation-item.priority-low {
        border-left: 4px solid var(--success-color);
    }
    
    .rec-priority {
        background: var(--muted-color);
        color: white;
        font-size: 0.8rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 999px;
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    .recommendation-item.priority-high .rec-priority {
        background: var(--danger-color);
    }
    
    .recommendation-item.priority-medium .rec-priority {
        background: #f39c12;
    }
    
    .recommendation-item.priority-low .rec-priority {
        background: var(--success-color);
    }
    
    .rec-content {
        flex: 1;
    }
    
    .rec-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }
    
    .rec-description {
        color: var(--text-secondary);
        line-height: 1.5;
        margin-bottom: 1rem;
    }
    
    .rec-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .rec-btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .rec-btn.primary {
        background: var(--accent-color);
        color: white;
    }
    
    .rec-btn.primary:hover {
        background: var(--accent-dark);
        transform: translateY(-1px);
    }
    
    .rec-btn.secondary {
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
    }
    
    .rec-btn.secondary:hover {
        background: var(--bg-secondary);
    }
    
    /* Patterns Grid */
    .patterns-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }
    
    .pattern-item {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1rem;
        transition: all 0.3s ease;
    }
    
    .pattern-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }
    
    .pattern-icon {
        width: 40px;
        height: 40px;
        background: var(--accent-soft);
        color: var(--accent-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        margin-bottom: 1rem;
    }
    
    .pattern-content {
        flex: 1;
    }
    
    .pattern-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }
    
    .pattern-description {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    
    .pattern-impact {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--accent-color);
    }
    
    /* ========================================
       DRILLDOWN MODAL
    ======================================== */
    .drilldown-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    }
    
    .drilldown-content {
        background: var(--bg-secondary);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-medium);
        max-width: 90vw;
        max-height: 90vh;
        overflow: auto;
        animation: modalSlideIn 0.3s ease;
    }
    
    .drilldown-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .drilldown-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }
    
    .drilldown-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: var(--border-radius);
        transition: var(--transition);
    }
    
    .drilldown-close:hover {
        background: var(--border-color);
        color: var(--text-primary);
    }
    
    .drilldown-body {
        padding: 1.5rem;
    }
    
    /* ========================================
       ANIMATIONS
    ======================================== */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    /* ========================================
       RESPONSIVE DESIGN
    ======================================== */
    @media (max-width: 768px) {
        .executive-dashboard {
            padding: 0.5rem;
        }
        
        .dashboard-header {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }
        
        .dashboard-title {
            font-size: 1.5rem;
        }
        
        .kpi-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .ai-intelligence-panel {
            padding: 1rem;
        }
        
        .ai-panel-header {
            flex-direction: column;
            gap: 0.5rem;
            text-align: center;
        }
        
        .predictions-grid {
            grid-template-columns: 1fr;
        }
        
        .recommendation-item {
            padding: 1rem;
        }
        
        .rec-actions {
            flex-direction: column;
        }
        
        .patterns-grid {
            grid-template-columns: 1fr;
        }
        
        .kpi-card {
            padding: 1rem;
        }
        
        .kpi-value {
            font-size: 2rem;
        }
        
        .period-selector {
            justify-content: center;
        }
        
        .drilldown-content {
            margin: 1rem;
            max-width: calc(100vw - 2rem);
            max-height: calc(100vh - 2rem);
        }
        
        .drilldown-header {
            padding: 1rem;
        }
        
        .drilldown-title {
            font-size: 1.25rem;
        }
        
        .drilldown-body {
            padding: 1rem;
        }
    }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <section class="login-wrap" id="loginView" aria-labelledby="loginTitle">
    <div class="landing-shell" id="landingShell">
      <div class="landing-hero">
        <div class="hero-wrap">
          <header class="site-header">
            <div class="brand" id="landingBrand" data-has-logo="false"><div class="logo"><span>GS</span><img class="logo-img" id="landingBrandLogo" alt="Logotipo corporativo" /></div><div class="brand-name" id="landingBrandName">Gesti√≥n Sostenible</div></div>
            <nav class="nav-links" aria-label="Navegaci√≥n de la landing">
              <a href="#que-es">Funciones</a>
              <a href="#por-que">Beneficios</a>
              <a href="#como">C√≥mo funciona</a>
              <a class="btn ghost" href="#loginPanel" data-action="focus-login">Iniciar sesi√≥n</a>
            </nav>
          </header>
          <div class="hero-grid">
            <div>
              <div class="login-pill">Plataforma operativa</div>
              <h1>Digitaliz√° tu gesti√≥n.<br/>Gan√° tiempo, sum√° impacto.</h1>
              <p>Administr√° clientes, agenda de retiros, finanzas y checklist fiscal en un √∫nico escritorio. Simple, r√°pido y seguro.</p>
              <div class="login-cta">
                <a class="btn primary" href="#loginPanel" data-action="focus-login">Iniciar sesi√≥n</a>
                <a class="btn ghost" href="#que-es">Ver funciones</a>
              </div>
            </div>
            <div class="laptop-mock" aria-hidden="true">
              <div class="laptop-top">
                <div class="laptop-camera"></div>
                <img src="assets/dashboard-preview.svg" alt="Vista del dashboard de Gesti√≥n Sostenible" class="laptop-screen" loading="lazy" />
              </div>
              <div class="laptop-base"></div>
            </div>
          </div>
        </div>
      </div>

      <section class="feature-section" id="que-es">
        <div class="wrap">
          <div class="kicker">Un sistema, todas tus operaciones</div>
          <h2>Todo en un solo lugar</h2>
          <p style="max-width:760px;margin:.4rem 0 1.2rem;color:var(--muted)">Automatiz√° las tareas del d√≠a a d√≠a: agenda y rutas en Google Maps, gesti√≥n de clientes, cobranzas y checklist fiscal con adjuntos. Sin planillas, sin duplicados.</p>
          <div class="feature-grid">
            <div class="card"><div class="pill">Calendario</div><h3>Retiros con rutas</h3><p>Planific√° y visualiz√° la ruta del d√≠a integrando direcciones con Google Maps y estados de retiro.</p></div>
            <div class="card"><div class="pill">Clientes</div><h3>Gesti√≥n en tiempo real</h3><p>Altas, b√∫squeda, contratos mensuales y montos. Todo sincronizado en tiempo real.</p></div>
            <div class="card"><div class="pill">Finanzas</div><h3>Cobros + DGI</h3><p>Pagos pendientes/recibidos y checklist fiscal mensual con adjuntos vinculados.</p></div>
          </div>
        </div>
      </section>

      <section class="feature-section" id="por-que">
        <div class="wrap">
          <div class="kicker">Eficiencia, control y sustentabilidad</div>
          <h2>¬øPor qu√© elegir Gesti√≥n Sostenible?</h2>
          <div class="feature-grid" style="margin-top:12px">
            <div class="card"><h3>‚ö° Operaciones en vivo</h3><p>Datos siempre actualizados, sin recargas completas ni planillas paralelas.</p></div>
            <div class="card"><h3>üîí Seguridad y roles</h3><p>Accesos por perfil (Administrador / Control). Autenticaci√≥n y permisos coherentes.</p></div>
            <div class="card"><h3>üìà Escalable</h3><p>Sum√° usuarios, clientes y m√≥dulos sin cambiar de sistema. Hosting est√°tico, costos bajos.</p></div>
          </div>
        </div>
      </section>

      <section class="feature-section" id="como">
        <div class="wrap">
          <div class="kicker">Simple y directo</div>
          <h2>Tu gesti√≥n en 3 pasos</h2>
          <div class="steps" style="margin-top:12px">
            <div class="card step"><div class="num">1</div><h3>Inici√° sesi√≥n</h3><p>Acced√© con tu usuario corporativo y manten√© la sesi√≥n activa entre m√≥dulos.</p></div>
            <div class="card step"><div class="num">2</div><h3>Organiz√° y oper√°</h3><p>Agenda de retiros, clientes y cobranzas desde un solo escritorio.</p></div>
            <div class="card step"><div class="num">3</div><h3>Control√° resultados</h3><p>Seguimiento de indicadores clave y checklist fiscal actualizado cada mes.</p></div>
          </div>
        </div>
      </section>

      <section class="cta-final" id="contacto">
        <div class="wrap">
          <div class="card">
            <h2 style="color:#eaffff">Empez√° tu gesti√≥n sostenible hoy</h2>
            <p style="margin:.3rem 0 1rem;color:#cfeaf3">Solicit√° una demo o ped√≠ tu acceso personalizado. Te acompa√±amos en la puesta en marcha.</p>
            <div class="login-cta">
              <a class="btn primary" href="#loginPanel" data-action="focus-login">Iniciar sesi√≥n</a>
              <a class="btn ghost" href="/cdn-cgi/l/email-protection#e78488899386849388a7808294938e88899488949382898e858b82c984888ad89492858d828493daa3828a88c2d5d7a08294938e245489c2d5d7b488949382898e858b82">Solicitar demo</a>
            </div>
          </div>
        </div>
      </section>
    </div>

    <section class="login-panel" id="loginPanel">
      <div class="login-card">
        <div class="brand" id="loginBrand" data-has-logo="false"><div class="logo" aria-hidden="true"><span>GS</span><img class="logo-img" id="loginBrandLogo" alt="Logotipo corporativo" /></div><div id="loginBrandName">Gesti√≥n Sostenible</div></div>
        <h1 id="loginTitle">Iniciar sesi√≥n</h1>
        <form class="row" style="margin:10px 0 6px;justify-content:center" id="loginForm" method="post" novalidate>
          <label class="sr-only" for="email">Correo electr√≥nico</label>
          <input id="email" name="email" type="email" placeholder="usuario@gestionsostenible.com" autocomplete="username" required>
          <label class="sr-only" for="pass">Contrase√±a</label>
          <input id="pass" name="password" type="password" placeholder="Contrase√±a" autocomplete="current-password" required>
          <button class="btn primary" id="btnLogin" type="submit">Entrar</button>
        </form>
        <div class="msg" id="loginMsg" role="status" aria-live="polite"></div>
      </div>
    </section>
  </section>

  <!-- APP -->
  <section class="app hidden" id="appView">
    <aside class="sidebar" aria-label="Navegaci√≥n principal">
      <div class="side-brand" id="sideBrand" data-has-logo="false"><div class="logo"><span>GS</span><img class="logo-img" id="sideBrandLogo" alt="Logotipo corporativo" /></div><div class="name" id="sideBrandName">Gesti√≥n Sostenible</div></div>
      <nav class="nav" id="sideNav" aria-label="Secciones de la aplicaci√≥n">
        <a href="#/"            data-page="/"          data-module-key="home"          class="active"><span aria-hidden="true">üè†</span> <span>Inicio</span></a>
        <a href="#/clientes"    data-page="clientes-firestore.html" data-module-key="clientes"><span aria-hidden="true">üë§</span> <span>Clientes</span></a>
        <a href="#/retiros"     data-page="retiros.html"             data-module-key="rutas"><span aria-hidden="true">üó∫Ô∏è</span> <span>Calendario / Rutas</span></a>
        <a href="#/finanzas"    data-page="finanzas.html"           data-module-key="finanzas"><span aria-hidden="true">üíµ</span> <span>Finanzas y DGI</span></a>
        <a href="#/temas"       data-page="temas.html"              data-module-key="temas" data-permission="manageTheme"><span aria-hidden="true">üé®</span> <span>Temas</span></a>
        <a href="#/usuarios"    data-page="usuarios.html"           data-module-key="usuarios" data-permission="manageUsers"><span aria-hidden="true">üõ°Ô∏è</span> <span>Gesti√≥n de Cuentas</span></a>
        <a href="#/configuracion" data-page="configuracion.html"    data-module-key="configuracion"><span aria-hidden="true">‚öôÔ∏è</span> <span>Configuraci√≥n</span></a>
      </nav>
      <div class="bottom">
        <button class="btn logout" id="btnLogout" type="button"><span aria-hidden="true">üö™</span> <span>Cerrar sesi√≥n</span></button>
      </div>
    </aside>

    <main class="main" role="main">
      <div class="header" role="presentation">
        <div class="header-main">
          <button class="menu-toggle" id="navToggle" type="button" aria-label="Abrir men√∫" aria-controls="sideNav" aria-expanded="false">‚ò∞</button>
          <div class="title-wrap">
            <div class="title" id="pageTitle">Inicio</div>
            <div class="subtitle" id="pageSubtitle">Resumen ejecutivo de tus indicadores clave.</div>
          </div>
        </div>
        <div class="session-chip hidden" id="sessionChip" role="status" aria-live="polite" data-role="guest">
          <span class="session-role" id="sessionRole">Invitado</span>
          <span class="session-email" id="sessionEmail">Sin sesi√≥n activa</span>
        </div>
      </div>
      <div class="viewer" id="viewer">
        <!-- Home (inline) -->
        <!-- Executive Command Center -->
        <div id="homeView" class="home-wrap" aria-live="polite">
          <!-- Dashboard Principal -->
          <div class="executive-dashboard" id="executiveDashboard">
            
            <!-- Alerts Banner -->
            <div class="alerts-banner" id="alertsBanner">
              <h3 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 1.1rem;">
                <svg width="20" height="20" style="vertical-align: middle; margin-right: 0.5rem;" fill="currentColor">
                  <use href="#icon-alert"></use>
                </svg>
                Alertas del Sistema
              </h3>
              <div class="alerts-content" id="alertsContent">
                <!-- Las alertas se cargan din√°micamente -->
              </div>
            </div>
            
            <!-- Period Selector -->
            <div class="period-selector" id="periodSelector">
              <button class="period-btn active" data-period="today">Hoy</button>
              <button class="period-btn" data-period="week">Esta Semana</button>
              <button class="period-btn" data-period="month">Este Mes</button>
              <button class="period-btn" data-period="quarter">Este Trimestre</button>
              <button class="period-btn" data-period="year">Este A√±o</button>
            </div>
            
            <!-- AI Intelligence Panel -->
            <div class="ai-intelligence-panel" id="aiIntelligencePanel">
              <div class="ai-panel-header">
                <h3>ü§ñ AI Intelligence Layer</h3>
                <div class="ai-status" id="aiStatus">
                  <span class="status-dot active"></span>
                  <span>An√°lisis en tiempo real</span>
                </div>
              </div>
              <div class="ai-content">
                <!-- Predicciones -->
                <div class="ai-section">
                  <h4>üìà Predicciones Pr√≥ximos 7 D√≠as</h4>
                  <div class="predictions-grid" id="predictionsGrid">
                    <div class="prediction-item">
                      <div class="prediction-icon">üìÖ</div>
                      <div class="prediction-content">
                        <div class="prediction-title">Retiros Estimados</div>
                        <div class="prediction-value">156 <span class="prediction-trend up">+12%</span></div>
                        <div class="prediction-confidence">Confianza: 94%</div>
                      </div>
                    </div>
                    <div class="prediction-item">
                      <div class="prediction-icon">üí∞</div>
                      <div class="prediction-content">
                        <div class="prediction-title">Ingresos Proyectados</div>
                        <div class="prediction-value">$287,500 <span class="prediction-trend up">+8.5%</span></div>
                        <div class="prediction-confidence">Confianza: 91%</div>
                      </div>
                    </div>
                    <div class="prediction-item">
                      <div class="prediction-icon">‚ö°</div>
                      <div class="prediction-content">
                        <div class="prediction-title">Eficiencia Esperada</div>
                        <div class="prediction-value">92.3% <span class="prediction-trend up">+1.8%</span></div>
                        <div class="prediction-confidence">Confianza: 89%</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Recomendaciones IA -->
                <div class="ai-section">
                  <h4>üí° Recomendaciones Inteligentes</h4>
                  <div class="recommendations-list" id="recommendationsList">
                    <div class="recommendation-item priority-high">
                      <div class="rec-priority">Alto</div>
                      <div class="rec-content">
                        <div class="rec-title">Optimizar rutas del Zona Norte</div>
                        <div class="rec-description">La IA detect√≥ patrones de ineficiencia en 3 rutas. Redistribuir 15% del volumen podr√≠a mejorar 8.5% la eficiencia.</div>
                        <div class="rec-actions">
                          <button class="rec-btn primary" onclick="implementRecommendation('optimize_routes')">Implementar</button>
                          <button class="rec-btn secondary" onclick="viewRecommendationDetails('optimize_routes')">Detalles</button>
                        </div>
                      </div>
                    </div>
                    <div class="recommendation-item priority-medium">
                      <div class="rec-priority">Medio</div>
                      <div class="rec-content">
                        <div class="rec-title">Ajustar horarios de retiro</div>
                        <div class="rec-description">Clientes en zona Sur prefieren horarios 8-10 AM. Reducir cancelaciones estimadas en 23%.</div>
                        <div class="rec-actions">
                          <button class="rec-btn primary" onclick="implementRecommendation('adjust_schedule')">Implementar</button>
                          <button class="rec-btn secondary" onclick="viewRecommendationDetails('adjust_schedule')">Detalles</button>
                        </div>
                      </div>
                    </div>
                    <div class="recommendation-item priority-low">
                      <div class="rec-priority">Bajo</div>
                      <div class="rec-content">
                        <div class="rec-title">Mantenimiento preventivo</div>
                        <div class="rec-description">Veh√≠culo #7 requiere mantenimiento en 3 d√≠as seg√∫n patrones de uso. Programar para evitar interrupciones.</div>
                        <div class="rec-actions">
                          <button class="rec-btn primary" onclick="implementRecommendation('maintenance')">Programar</button>
                          <button class="rec-btn secondary" onclick="viewRecommendationDetails('maintenance')">Detalles</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Detecci√≥n de Patrones -->
                <div class="ai-section">
                  <h4>üîç Patrones Detectados</h4>
                  <div class="patterns-grid" id="patternsGrid">
                    <div class="pattern-item">
                      <div class="pattern-icon">üìä</div>
                      <div class="pattern-content">
                        <div class="pattern-title">Incremento 15% volumen</div>
                        <div class="pattern-description">√öltima semana vs anterior en zona Este</div>
                        <div class="pattern-impact">Impacto: +$12,300/mes</div>
                      </div>
                    </div>
                    <div class="pattern-item">
                      <div class="pattern-icon">‚ö†Ô∏è</div>
                      <div class="pattern-content">
                        <div class="pattern-title">Cancelaciones altas</div>
                        <div class="pattern-description">Horarios 14-16 PM tienen 18% m√°s cancelaciones</div>
                        <div class="pattern-impact">Impacto: -$8,500/mes</div>
                      </div>
                    </div>
                    <div class="pattern-item">
                      <div class="pattern-icon">‚úÖ</div>
                      <div class="pattern-content">
                        <div class="pattern-title">Clientes recurrentes</div>
                        <div class="pattern-description">92% de clientes vuelven en 30 d√≠as</div>
                        <div class="pattern-impact">LTV promedio: $2,400</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- KPI Cards Grid -->
            <div class="kpi-grid" id="kpiGrid">
              
              <!-- Retiros Programados Card -->
              <div class="kpi-card" data-kpi="retiros" data-module="retiros.html">
                <div class="kpi-header">
                  <h3 class="kpi-title">Retiros Programados</h3>
                  <div class="kpi-icon">üìÖ</div>
                </div>
                <div class="kpi-metrics">
                  <div class="kpi-value" id="retirosValue">‚Äî</div>
                  <div class="kpi-change positive" id="retirosChange">
                    <svg width="16" height="16" fill="currentColor">
                      <use href="#icon-trending-up"></use>
                    </svg>
                    <span id="retirosChangeValue">‚Äî</span>
                  </div>
                </div>
                <div class="kpi-chart-container">
                  <canvas class="kpi-chart" id="retirosChart"></canvas>
                </div>
              </div>
              
              <!-- Ingresos Diarios Card -->
              <div class="kpi-card" data-kpi="ingresos" data-module="finanzas.html">
                <div class="kpi-header">
                  <h3 class="kpi-title">Ingresos Diarios</h3>
                  <div class="kpi-icon">üí∞</div>
                </div>
                <div class="kpi-metrics">
                  <div class="kpi-value" id="ingresosValue">‚Äî</div>
                  <div class="kpi-change positive" id="ingresosChange">
                    <svg width="16" height="16" fill="currentColor">
                      <use href="#icon-trending-up"></use>
                    </svg>
                    <span id="ingresosChangeValue">‚Äî</span>
                  </div>
                </div>
                <div class="kpi-chart-container">
                  <canvas class="kpi-chart" id="ingresosChart"></canvas>
                </div>
              </div>
              
              <!-- Eficiencia Operativa Card -->
              <div class="kpi-card" data-kpi="eficiencia" data-module="configuracion.html">
                <div class="kpi-header">
                  <h3 class="kpi-title">Eficiencia Operativa</h3>
                  <div class="kpi-icon">‚ö°</div>
                </div>
                <div class="kpi-metrics">
                  <div class="kpi-value" id="eficienciaValue">‚Äî</div>
                  <div class="kpi-change positive" id="eficienciaChange">
                    <svg width="16" height="16" fill="currentColor">
                      <use href="#icon-trending-up"></use>
                    </svg>
                    <span id="eficienciaChangeValue">‚Äî</span>
                  </div>
                </div>
                <div class="kpi-chart-container">
                  <canvas class="kpi-chart" id="eficienciaChart"></canvas>
                </div>
              </div>
              
            </div>
            
          </div>
          
          <!-- Drilldown Modal -->
          <div class="drilldown-modal hidden" id="drilldownModal">
            <div class="drilldown-content">
              <div class="drilldown-header">
                <h3 class="drilldown-title" id="drilldownTitle">Detalles</h3>
                <button class="drilldown-close" id="drilldownClose">
                  <svg width="24" height="24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                  </svg>
                </button>
              </div>
              <div class="drilldown-body" id="drilldownBody">
                <!-- El contenido detallado se carga din√°micamente -->
              </div>
            </div>
          </div>
          
        </div>
        <!-- M√≥dulos -->
        <div class="viewer-loading hidden" id="viewerLoading" aria-live="polite" aria-atomic="true">
          <div class="spinner" role="presentation"></div>
          <div>
            <div id="viewerLoadingTitle" style="font-weight:600;color:var(--ink)">Gesti√≥n Sostenible ¬∑ Cargando</div>
            <div id="viewerLoadingText">Sincronizando la vista con tu sesi√≥n.</div>
          </div>
        </div>
        <div class="viewer-error hidden" id="viewerError" role="alert">
          <div class="icon" aria-hidden="true">‚ö†Ô∏è</div>
          <div>
            <h3 id="viewerErrorTitle">No pudimos abrir el m√≥dulo.</h3>
            <p id="viewerErrorText">Revis√° tu conexi√≥n o que el archivo exista en el servidor antes de reintentar.</p>
            <div class="actions">
              <button type="button" class="btn outline" id="viewerErrorRetry">Reintentar carga</button>
              <button type="button" class="btn primary" id="viewerErrorHome">Volver al inicio</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </section>
  <div class="nav-backdrop" id="navBackdrop" hidden></div>

  <!-- Chart.js para Executive Command Center -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  
  <!-- Firebase compat -->
  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

  <!-- Auth compartido (ya lo ten√©s) -->
  <script src="assets/demo-data.js"></script>
  <script src="assets/gs-auth.js"></script>

  <script>
    // Refs
    const $ = sel => document.querySelector(sel);
    const loginView = $('#loginView');
    const appView   = $('#appView');
    const msg       = $('#loginMsg');
    const viewer    = $('#viewer');
    const homeView  = $('#homeView');
    const pageTitle = $('#pageTitle');
    const pageSubtitle = $('#pageSubtitle');
    const sideNav   = $('#sideNav');
    const navLinksWithPermission = sideNav ? Array.from(sideNav.querySelectorAll('a[data-permission]')) : [];
    const navModuleLinks = sideNav ? Array.from(sideNav.querySelectorAll('a[data-page]')) : [];
    const navToggle = $('#navToggle');
    const navBackdrop = $('#navBackdrop');
    const viewerLoading = $('#viewerLoading');
    const viewerLoadingTitle = $('#viewerLoadingTitle');
    const viewerLoadingText = $('#viewerLoadingText');
    const viewerError = $('#viewerError');
    const viewerErrorTitle = $('#viewerErrorTitle');
    const viewerErrorText = $('#viewerErrorText');
    const viewerErrorRetry = $('#viewerErrorRetry');
    const viewerErrorHome = $('#viewerErrorHome');
    const sessionChip = $('#sessionChip');
    const sessionRole = $('#sessionRole');
    const sessionEmail = $('#sessionEmail');
    const loginForm = $('#loginForm');
    const emailInput = $('#email');
    const passInput = $('#pass');
    const btnLogin = $('#btnLogin');
    const landingBrand = $('#landingBrand');
    const landingBrandLogo = $('#landingBrandLogo');
    const landingBrandLogoWrap = landingBrand ? landingBrand.querySelector('.logo') : null;
    const landingBrandName = $('#landingBrandName');
    const landingShell = $('#landingShell');
    const loginBrand = $('#loginBrand');
    const loginBrandLogo = $('#loginBrandLogo');
    const loginBrandLogoWrap = loginBrand ? loginBrand.querySelector('.logo') : null;
    const loginBrandName = $('#loginBrandName');
    const loginPanel = $('#loginPanel');
    const sideBrand = $('#sideBrand');
    const sideBrandLogo = $('#sideBrandLogo');
    const sideBrandLogoWrap = sideBrand ? sideBrand.querySelector('.logo') : null;
    const sideBrandName = $('#sideBrandName');
    const STORAGE_KEY = 'gs:lastRoute';
    const ROLE_LABELS = Object.assign({ guest: 'Invitado' }, (gsAuth && gsAuth.roleLabels) ? gsAuth.roleLabels : {});
    const normalizeRole = (gsAuth && typeof gsAuth.normalizeRole === 'function')
      ? ((role, context)=> gsAuth.normalizeRole(role, context))
      : ((role)=> typeof role === 'string' ? role.toLowerCase() : 'control');
    const DEFAULT_BRAND_NAME = 'Gesti√≥n Sostenible';
    const DEFAULT_MODULE_LABELS = Object.freeze({
      home: 'Inicio',
      clientes: 'Clientes',
      rutas: 'Calendario / Rutas',
      finanzas: 'Finanzas y DGI',
      temas: 'Temas',
      usuarios: 'Gesti√≥n de Cuentas',
      configuracion: 'Configuraci√≥n'
    });
    const getActiveBrandName = ()=>{
      try{
        const snap = typeof getThemeSnapshot === 'function' ? getThemeSnapshot() : null;
        if(snap && snap.brandName){ return snap.brandName; }
        if(snap && snap.logo && snap.logo.name){ return snap.logo.name; }
      }catch(err){ /* noop */ }
      return DEFAULT_BRAND_NAME;
    };
    const focusLoginBtns = Array.from(document.querySelectorAll('[data-action="focus-login"]'));
    const focusLoginForm = (event)=>{
      if(event){ event.preventDefault(); }
      document.body.classList.add('login-open');
      if(loginPanel){
        loginPanel.classList.remove('hidden');
        loginPanel.removeAttribute('aria-hidden');
      }
      if(landingShell){ landingShell.setAttribute('aria-hidden','true'); }
      const card = document.querySelector('.login-card');
      if(card){ card.scrollIntoView({ behavior:'smooth', block:'center' }); }
      if(emailInput){
        try{ emailInput.focus({ preventScroll:true }); }catch(err){ emailInput.focus(); }
      }
    };
    focusLoginBtns.forEach(btn=> btn.addEventListener('click', focusLoginForm));
    if(new URLSearchParams(window.location.search).get('login') === '1'){
      focusLoginForm();
    }
    const routes = {
      '/': {
        moduleKey: 'home',
        defaultTitle: DEFAULT_MODULE_LABELS.home,
        page: null,
        subtitle: 'Resumen ejecutivo de tus indicadores clave.'
      },
      '/clientes': {
        moduleKey: 'clientes',
        defaultTitle: DEFAULT_MODULE_LABELS.clientes,
        page: 'clientes-firestore.html'
      },
      '/retiros': {
        moduleKey: 'rutas',
        defaultTitle: DEFAULT_MODULE_LABELS.rutas,
        page: 'retiros.html'
      },
      '/finanzas': {
        moduleKey: 'finanzas',
        defaultTitle: DEFAULT_MODULE_LABELS.finanzas,
        page: 'finanzas.html'
      },
      '/temas': {
        moduleKey: 'temas',
        defaultTitle: DEFAULT_MODULE_LABELS.temas,
        page: 'temas.html',
        permission: 'manageTheme',
        subtitle: 'Personaliz√° colores, logotipo y branding.'
      },
      '/usuarios': {
        moduleKey: 'usuarios',
        defaultTitle: DEFAULT_MODULE_LABELS.usuarios,
        page: 'usuarios.html',
        permission: 'manageUsers',
        subtitle: 'Cre√°, desactiv√° y audit√° cuentas corporativas.'
      },
      '/configuracion': {
        moduleKey: 'configuracion',
        defaultTitle: DEFAULT_MODULE_LABELS.configuracion,
        page: 'configuracion.html',
        subtitle: 'Actualiz√° tus datos de acceso y personaliz√° la experiencia.'
      }
    };
    let moduleLabels = Object.assign({}, DEFAULT_MODULE_LABELS);
    const urlParams = new URLSearchParams(location.search);
    const demoRequested = urlParams.get('demo') === '1' || urlParams.get('mode') === 'demo';
    const LANDING_FULL_URL = 'landing.html';
    const LANDING_DEMO_URL = 'landing-demo.html';
    let landingRedirectScheduled = false;
    const ensureLandingRedirect = (mode)=>{
      if(landingRedirectScheduled){ return; }
      landingRedirectScheduled = true;
      let target = LANDING_FULL_URL;
      const normalizedMode = mode || ((typeof gsAuth !== 'undefined' && gsAuth && typeof gsAuth.isDemoSession === 'function' && gsAuth.isDemoSession()) ? 'demo' : (demoRequested ? 'demo' : 'full'));
      if(normalizedMode === 'demo'){
        target = LANDING_DEMO_URL;
      }
      if(window.top && window.top !== window.self){
        try{ window.top.location.replace(target); }
        catch(err){ window.location.replace(target); }
      }else{
        window.location.replace(target);
      }
    };
    let currentSession = null;
    let sessionAbilities = {};
    let lastProfileStamp = null;
    let appInitializedFor = null;
    let lastSession = null;
    const frameCache = new Map();
    let activeFrame = null;
    let warmupTimer = null;
    const homeCardState = new Map();

    const idleScheduler = (cb, opts={})=>{
      if(typeof requestIdleCallback === 'function'){
        return requestIdleCallback(cb, opts);
      }
      return setTimeout(cb, opts && opts.timeout ? opts.timeout : 200);
    };

    let currentBrandLogo = null;
    let lastBrandMetrics = null;

    function getModuleLabel(key){
      if(!key){ return ''; }
      return moduleLabels[key] || DEFAULT_MODULE_LABELS[key] || '';
    }

    function syncNavModuleLabels(){
      navModuleLinks.forEach((link)=>{
        const key = link.dataset.moduleKey;
        if(!key){ return; }
        const labelSpan = link.querySelector('span:last-child');
        const label = getModuleLabel(key);
        if(labelSpan && label){
          labelSpan.textContent = label;
        }
      });
    }

    function refreshActiveRouteTitle(){
      const hash = location.hash || '#/';
      const key = hash.replace('#','');
      const route = routes[key] || routes['/'];
      if(!route){ return; }
      const label = getModuleLabel(route.moduleKey) || route.defaultTitle || '';
      if(pageTitle && label){
        pageTitle.textContent = label;
      }
    }

    function computeLogoMetrics(logo, image){
      const baseWidth = 42;
      const baseHeight = 42;
      const metrics = { width: `${baseWidth}px`, height: `${baseHeight}px`, shape: 'square', aspect: 1 };
      if(!logo){ return metrics; }
      let aspect = null;
      if(typeof logo.aspect === 'number' && Number.isFinite(logo.aspect) && logo.aspect > 0){
        aspect = logo.aspect;
      }
      if(!aspect && image && image.naturalWidth && image.naturalHeight){
        aspect = image.naturalWidth / image.naturalHeight;
      }
      if(!aspect || !Number.isFinite(aspect) || aspect <= 0.05){
        return metrics;
      }
      aspect = Math.min(Math.max(aspect, 0.1), 8);
      metrics.aspect = aspect;
      if(aspect >= 1.35){
        metrics.shape = 'wide';
        metrics.width = `${Math.min(Math.max(baseWidth * aspect, 52), 168).toFixed(2)}px`;
        metrics.height = `${baseHeight}px`;
      }else if(aspect <= 0.75){
        metrics.shape = 'tall';
        metrics.width = `${baseWidth}px`;
        metrics.height = `${Math.min(Math.max(baseHeight / Math.max(aspect, 0.2), baseHeight), 78).toFixed(2)}px`;
      }else{
        metrics.shape = 'square';
        metrics.width = `${Math.min(Math.max(baseWidth * Math.max(aspect, 0.9), 40), 60).toFixed(2)}px`;
        metrics.height = `${baseHeight}px`;
      }
      return metrics;
    }

    function applyLogoMetrics(metrics){
      if(!metrics){ return; }
      const wrappers = [loginBrandLogoWrap, sideBrandLogoWrap, landingBrandLogoWrap];
      wrappers.forEach((wrap)=>{
        if(!wrap){ return; }
        wrap.style.setProperty('--brand-logo-width', metrics.width);
        wrap.style.setProperty('--brand-logo-height', metrics.height);
        wrap.style.width = metrics.width;
        wrap.style.height = metrics.height;
      });
      const containers = [loginBrand, sideBrand, landingBrand];
      containers.forEach((container)=>{
        if(!container){ return; }
        if(metrics.shape){
          container.dataset.logoShape = metrics.shape;
        }else{
          delete container.dataset.logoShape;
        }
        container.style.setProperty('--brand-logo-aspect', metrics.aspect ? metrics.aspect.toFixed(3) : '1');
      });
      lastBrandMetrics = metrics;
    }

    function resetLogoMetrics(){
      lastBrandMetrics = null;
      [loginBrandLogoWrap, sideBrandLogoWrap, landingBrandLogoWrap].forEach((wrap)=>{
        if(!wrap){ return; }
        wrap.style.removeProperty('--brand-logo-width');
        wrap.style.removeProperty('--brand-logo-height');
        wrap.style.removeProperty('width');
        wrap.style.removeProperty('height');
      });
      [loginBrand, sideBrand, landingBrand].forEach((container)=>{
        if(!container){ return; }
        container.style.removeProperty('--brand-logo-aspect');
        delete container.dataset.logoShape;
      });
    }

    function ensureLogoMetrics(logo){
      if(!logo){
        resetLogoMetrics();
        return;
      }
      const metrics = computeLogoMetrics(logo, loginBrandLogo);
      if(!lastBrandMetrics
        || lastBrandMetrics.width !== metrics.width
        || lastBrandMetrics.height !== metrics.height
        || lastBrandMetrics.shape !== metrics.shape){
        applyLogoMetrics(metrics);
      }
    }

    function applyBranding(theme){
      const modules = theme && theme.modules ? theme.modules : null;
      moduleLabels = Object.assign({}, DEFAULT_MODULE_LABELS, modules || {});
      syncNavModuleLabels();
      refreshActiveRouteTitle();

      const logo = theme && theme.logo ? theme.logo : null;
      currentBrandLogo = logo && (logo.dataUrl || logo.url) ? logo : null;
      const brandName = theme && theme.brandName
        ? theme.brandName
        : (logo && logo.name) ? logo.name : DEFAULT_BRAND_NAME;
      if(landingBrandName){ landingBrandName.textContent = brandName; }
      if(loginBrandName){ loginBrandName.textContent = brandName; }
      if(sideBrandName){ sideBrandName.textContent = brandName; }

      const hasLogo = !!(logo && (logo.dataUrl || logo.url));
      if(landingBrand){ landingBrand.dataset.hasLogo = hasLogo ? 'true' : 'false'; }
      if(loginBrand){ loginBrand.dataset.hasLogo = hasLogo ? 'true' : 'false'; }
      if(sideBrand){ sideBrand.dataset.hasLogo = hasLogo ? 'true' : 'false'; }

      const altText = brandName ? `Logotipo de ${brandName}` : 'Logotipo corporativo';

      if(landingBrandLogo){
        if(hasLogo){
          const src = logo.dataUrl || logo.url || '';
          if(src && landingBrandLogo.src !== src){ landingBrandLogo.src = src; }
          landingBrandLogo.alt = altText;
        }else{
          landingBrandLogo.removeAttribute('src');
          landingBrandLogo.alt = 'Logotipo corporativo';
        }
      }
      if(loginBrandLogo){
        if(hasLogo){
          const src = logo.dataUrl || logo.url || '';
          if(src && loginBrandLogo.src !== src){ loginBrandLogo.src = src; }
          loginBrandLogo.alt = altText;
        }else{
          loginBrandLogo.removeAttribute('src');
          loginBrandLogo.alt = 'Logotipo corporativo';
        }
      }
      if(sideBrandLogo){
        if(hasLogo){
          const src = logo.dataUrl || logo.url || '';
          if(src && sideBrandLogo.src !== src){ sideBrandLogo.src = src; }
          sideBrandLogo.alt = altText;
        }else{
          sideBrandLogo.removeAttribute('src');
          sideBrandLogo.alt = 'Logotipo corporativo';
        }
      }

      if(hasLogo){
        ensureLogoMetrics(currentBrandLogo);
      }else{
        resetLogoMetrics();
      }
    }

    if(loginBrandLogo){
      loginBrandLogo.addEventListener('load', ()=>{
        if(currentBrandLogo){ ensureLogoMetrics(currentBrandLogo); }
      });
      loginBrandLogo.addEventListener('error', ()=>{
        currentBrandLogo = null;
        if(loginBrand){ loginBrand.dataset.hasLogo = 'false'; }
        if(sideBrand){ sideBrand.dataset.hasLogo = 'false'; }
        resetLogoMetrics();
      });
    }
    if(sideBrandLogo){
      sideBrandLogo.addEventListener('load', ()=>{
        if(currentBrandLogo){ ensureLogoMetrics(currentBrandLogo); }
      });
      sideBrandLogo.addEventListener('error', ()=>{
        if(sideBrand){ sideBrand.dataset.hasLogo = 'false'; }
      });
    }

    const cancelIdleTask = (handle)=>{
      if(!handle) return;
      if(typeof cancelIdleCallback === 'function'){
        cancelIdleCallback(handle);
      }else{
        clearTimeout(handle);
      }
    };

    function ensureModuleFrame(page, title){
      if(!viewer || !page) return null;
      if(frameCache.has(page)){
        const existing = frameCache.get(page);
        if(title){ existing.setAttribute('title', `Vista del m√≥dulo: ${title}`); }
        existing.dataset.pageLabel = title || '';
        return existing;
      }
      const iframe = document.createElement('iframe');
      iframe.className = 'module-frame hidden';
      iframe.setAttribute('loading', 'lazy');
      iframe.setAttribute('data-page', page);
      iframe.setAttribute('title', `Vista del m√≥dulo: ${title || 'M√≥dulo embebido'}`);
      iframe.setAttribute('aria-hidden', 'true');
      iframe.setAttribute('tabindex', '-1');
      iframe.dataset.pageLabel = title || '';
      iframe.addEventListener('load', ()=>{
        iframe.dataset.loaded = 'true';
        iframe.classList.add('loaded');
        hideModuleError();
        if(activeFrame === iframe){
          hideLoader();
        }
      });
      iframe.addEventListener('error', ()=>{
        // Avisamos al usuario cuando el iframe no pudo cargar, √∫til antes de desplegar en hosting.
        iframe.dataset.loaded = '';
        iframe.classList.remove('loaded');
        if(activeFrame === iframe){
          showModuleError(
            iframe.dataset.pageLabel || 'el m√≥dulo',
            `No pudimos cargar ${iframe.dataset.pageLabel || 'este m√≥dulo'}. Verific√° que ${page} est√© publicado y volv√© a intentar.`
          );
        }
      });
      viewer.appendChild(iframe);
      frameCache.set(page, iframe);
      return iframe;
    }

    function hideModuleFrames(except){
      frameCache.forEach((iframe)=>{
        if(iframe === except) return;
        iframe.classList.add('hidden');
        iframe.setAttribute('aria-hidden', 'true');
        iframe.setAttribute('tabindex', '-1');
      });
    }

    function resetModuleFrames(){
      frameCache.forEach((iframe)=> iframe.remove());
      frameCache.clear();
      activeFrame = null;
    }

    function cancelModuleWarmup(){
      if(warmupTimer){
        cancelIdleTask(warmupTimer);
        warmupTimer = null;
      }
    }

    function warmupModuleFrames(){
      if(!viewer) return;
      navModuleLinks.forEach((link, index)=>{
        const perm = link.dataset.permission;
        if(perm && !(sessionAbilities && sessionAbilities[perm])) return;
        const page = link.dataset.page;
        if(!page || page === '/' || page === '#') return;
        const label = (link.textContent || '').trim();
        const frame = ensureModuleFrame(page, label);
        if(frame && !frame.getAttribute('src')){
          const delay = index * 250;
          idleScheduler(()=>{
            const cached = frameCache.get(page);
            if(!cached || cached.dataset.loaded === 'true' || cached.getAttribute('src')) return;
            cached.setAttribute('src', page);
          }, { timeout: 1200 + delay });
        }
      });
    }

    function scheduleModuleWarmup(){
      cancelModuleWarmup();
      warmupTimer = idleScheduler(()=>{
        warmupTimer = null;
        warmupModuleFrames();
      }, { timeout: 900 });
    }

    document.body.classList.remove('app-ready');
    applyBranding(null);
    if(window.gsAuth && typeof gsAuth.onTheme === 'function'){
      gsAuth.onTheme(applyBranding);
    }

    const homeCards = {
      retiros: { value: $('#homeRetirosValue'), meta: $('#homeRetirosMeta') },
      agenda: { value: $('#homeAgendaValue'), meta: $('#homeAgendaMeta') },
      ruta: { value: $('#homeRutaValue'), meta: $('#homeRutaMeta') },
      clientes: { value: $('#homeClientesValue'), meta: $('#homeClientesMeta') },
      clientesAlert: { value: $('#homeClientesAlertValue'), meta: $('#homeClientesAlertMeta') },
      cobros: { value: $('#homeCobrosValue'), meta: $('#homeCobrosMeta') },
      cobrosProgreso: { value: $('#homeCobrosPctValue'), meta: $('#homeCobrosPctMeta') },
      acceso: { value: $('#homeAccesoValue'), meta: $('#homeAccesoMeta') }
    };
    const HOME_DEFAULTS = {
      retiros: { value: '‚Äî', meta: 'Sincronizando agenda de hoy‚Ä¶' },
      agenda: { value: '‚Äî', meta: 'Calculando progreso de retiros‚Ä¶' },
      ruta: { value: '‚Äî', meta: 'Estimando facturaci√≥n de los retiros programados‚Ä¶' },
      clientes: { value: '‚Äî', meta: 'Cargando cartera de clientes‚Ä¶' },
      clientesAlert: { value: '‚Äî', meta: 'Identificando cuentas a regularizar‚Ä¶' },
      cobros: { value: '‚Äî', meta: 'Sincronizando finanzas del mes‚Ä¶' },
      cobrosProgreso: { value: '‚Äî', meta: 'Esperando informaci√≥n de pagos‚Ä¶' },
      acceso: { value: '‚Äî', meta: 'Registraremos tu pr√≥ximo inicio de sesi√≥n aqu√≠.' }
    };
    const homeData = { retiros: null, clientes: null, pagos: null };

    function clearHomeData(){
      homeData.retiros = null;
      homeData.clientes = null;
      homeData.pagos = null;
    }

    function setHomeData(key, payload){
      if(!(key in homeData)) return;
      homeData[key] = payload;
      renderHomeInsights();
    }

    function buildUpdatedMeta(ts, fromCache=false){
      if(!ts) return '';
      return `Actualizado ${formatTimestamp(ts)}${fromCache ? ' (memoria)' : ''}`;
    }

    function summarizeRetiros(source={}, options={}){
      const { fromCache=false } = options;
      const fecha = source.fecha || todayYMD();
      const isToday = fecha === todayYMD();
      const rawItems = Array.isArray(source.items) ? source.items : [];
      const items = rawItems.map(item=>({
        id: item.id || '',
        clienteId: item.clienteId || item.cliente || '',
        estado: (item.estado || '').toLowerCase(),
        monto: item.monto || ''
      }));
      const total = items.length;
      const realizados = items.filter(item=>item.estado === 'realizado').length;
      const pendientes = Math.max(total - realizados, 0);
      return {
        fromCache,
        fecha,
        isToday,
        updatedAt: source.updatedAt || null,
        total,
        realizados,
        pendientes,
        items
      };
    }

    function summarizeClientes(source={}, options={}){
      const { fromCache=false } = options;
      const list = Array.isArray(source.data) ? source.data : Array.isArray(source.list) ? source.list : [];
      const items = list.map(item=>({
        id: item.id || '',
        contrato: !!item.contrato,
        monto: item.monto || '',
        nombre: item.nombre || ''
      }));
      const total = items.length;
      const activos = items.filter(item=>item.contrato).length;
      const mapById = items.reduce((acc,item)=>{
        if(item.id){ acc[item.id] = item; }
        return acc;
      },{});
      return {
        fromCache,
        updatedAt: source.updatedAt || null,
        total,
        activos,
        sinContrato: Math.max(total - activos, 0),
        list: items,
        mapById
      };
    }

    function summarizePagos(source={}, options={}){
      const { fromCache=false } = options;
      const rawItems = Array.isArray(source.items) ? source.items : [];
      const items = rawItems.map(item=>({
        estado: (item.estado || '').toLowerCase(),
        monto: toNumber(item.monto),
        mes: item.mes || source.mes || currentMonth()
      }));
      const mes = source.mes || currentMonth();
      const isMesActual = mes === currentMonth();
      let pendientes = 0;
      let cobrados = 0;
      items.forEach(item=>{
        if(item.estado === 'pendiente') pendientes += item.monto;
        else if(item.estado === 'recibido') cobrados += item.monto;
      });
      const total = pendientes + cobrados;
      const eficiencia = total > 0 ? Math.round((cobrados / total) * 100) : 0;
      return {
        fromCache,
        mes,
        isMesActual,
        updatedAt: source.updatedAt || null,
        pendientes,
        cobrados,
        total,
        eficiencia,
        items
      };
    }

    function renderHomeInsights(){
      const retiros = homeData.retiros;
      const clientes = homeData.clientes;
      const pagos = homeData.pagos;

      if(retiros){
        const metaParts = [];
        const fechaLabel = formatDateHuman(retiros.fecha);
        if(fechaLabel){ metaParts.push(`Agenda ${fechaLabel}${retiros.isToday ? '' : ' (√∫ltima consultada)'}`); }
        metaParts.push(`Realizados ${numberFormatter.format(retiros.realizados)}`);
        metaParts.push(`Pendientes ${numberFormatter.format(retiros.pendientes)}`);
        const updatedLabel = buildUpdatedMeta(retiros.updatedAt, retiros.fromCache);
        if(updatedLabel){ metaParts.push(updatedLabel); }
        updateHomeCard('retiros', {
          value: numberFormatter.format(retiros.total),
          meta: metaParts.join(' ¬∑ ')
        });

        const progress = retiros.total ? Math.min(100, Math.round((retiros.realizados / retiros.total) * 100)) : 0;
        const agendaMeta = [];
        if(retiros.total){
          agendaMeta.push(`${numberFormatter.format(retiros.realizados)} de ${numberFormatter.format(retiros.total)} completados`);
          agendaMeta.push(`${numberFormatter.format(retiros.pendientes)} pendientes`);
        }else{
          agendaMeta.push('Sin retiros programados');
        }
        if(updatedLabel){ agendaMeta.push(updatedLabel); }
        updateHomeCard('agenda', {
          value: `${numberFormatter.format(progress)}%`,
          meta: agendaMeta.join(' ¬∑ ')
        });
      }

      if(clientes){
        const metaParts = [`de ${numberFormatter.format(clientes.total)} registrados`];
        const updatedLabel = buildUpdatedMeta(clientes.updatedAt, clientes.fromCache);
        if(updatedLabel){ metaParts.push(updatedLabel); }
        updateHomeCard('clientes', {
          value: numberFormatter.format(clientes.activos),
          meta: metaParts.join(' ¬∑ ')
        });

        const alertMeta = [];
        if(clientes.sinContrato === 0){
          alertMeta.push('Todos con contrato activo');
        }else{
          alertMeta.push('Revis√° firmas pendientes');
        }
        if(updatedLabel){ alertMeta.push(updatedLabel); }
        updateHomeCard('clientesAlert', {
          value: numberFormatter.format(clientes.sinContrato),
          meta: alertMeta.join(' ¬∑ ')
        });
      }

      if(pagos){
        const metaParts = [`${moneyFormatter.format(pagos.cobrados)} cobrados`];
        const mesLabel = formatMonth(pagos.mes);
        if(mesLabel){ metaParts.push(mesLabel); }
        if(!pagos.isMesActual){ metaParts.push('Basado en √∫ltimo mes consultado'); }
        const updatedLabel = buildUpdatedMeta(pagos.updatedAt, pagos.fromCache);
        if(updatedLabel){ metaParts.push(updatedLabel); }
        updateHomeCard('cobros', {
          value: moneyFormatter.format(pagos.pendientes),
          meta: metaParts.join(' ¬∑ ')
        });

        const progresoMeta = [];
        if(pagos.total > 0){
          progresoMeta.push(`${moneyFormatter.format(pagos.cobrados)} de ${moneyFormatter.format(pagos.total)} confirmados`);
        }else{
          progresoMeta.push('Sin cobranzas registradas');
        }
        if(!pagos.isMesActual){ progresoMeta.push('Basado en √∫ltimo mes consultado'); }
        if(updatedLabel){ progresoMeta.push(updatedLabel); }
        updateHomeCard('cobrosProgreso', {
          value: `${numberFormatter.format(pagos.eficiencia)}%`,
          meta: progresoMeta.join(' ¬∑ ')
        });
      }

      if(retiros && clientes){
        const map = clientes.mapById || {};
        const totalMonto = retiros.items.reduce((acc,item)=>{
          if(item.monto){
            return acc + toNumber(item.monto);
          }
          const cliente = map[item.clienteId];
          return acc + toNumber(cliente?.monto);
        }, 0);
        const metaParts = [];
        const fechaLabel = formatDateHuman(retiros.fecha);
        if(fechaLabel){ metaParts.push(`Agenda ${fechaLabel}${retiros.isToday ? '' : ' (√∫ltima consultada)'}`); }
        if(retiros.total){ metaParts.push(`${numberFormatter.format(retiros.total)} clientes agendados`); }
        const lastUpdated = Math.max(retiros.updatedAt || 0, clientes.updatedAt || 0);
        const fromCache = !!(retiros.fromCache || clientes.fromCache);
        const updatedLabel = buildUpdatedMeta(lastUpdated, fromCache);
        if(updatedLabel){ metaParts.push(updatedLabel); }
        if(totalMonto > 0){
          metaParts.push('Estimaci√≥n seg√∫n montos de cada cliente');
        }else if(retiros.total > 0){
          metaParts.push('Sin montos asignados a los clientes agendados');
        }else{
          metaParts.push('Sin retiros programados');
        }
        updateHomeCard('ruta', {
          value: totalMonto > 0 ? moneyFormatter.format(totalMonto) : (retiros.total > 0 ? moneyFormatter.format(0) : '‚Äî'),
          meta: metaParts.join(' ¬∑ ')
        });
      }else if(retiros && !clientes){
        updateHomeCard('ruta', {
          value: HOME_DEFAULTS.ruta.value,
          meta: 'Esperando la cartera para estimar el valor de la ruta.'
        });
      }
    }

    const localStore = (()=>{
      try{
        const probe = '__gs_home__';
        localStorage.setItem(probe,'1');
        localStorage.removeItem(probe);
        return localStorage;
      }catch(err){
        return null;
      }
    })();

    if(demoRequested && gsAuth && typeof gsAuth.startDemoSession === 'function'){
      try{ gsAuth.startDemoSession(window.GS_DEMO_DATA || {}); }
      catch(err){ console.error('No se pudo iniciar la demo', err); }
    }else if(!demoRequested){
      if(gsAuth && typeof gsAuth.isDemoSession === 'function' && gsAuth.isDemoSession()){
        gsAuth.endDemoSession({ clearStorage: true });
      }else if(localStore){
        try{ localStore.removeItem('gs:demo:mode'); localStore.removeItem('gs:demo:data'); }
        catch(err){ /* sin almacenamiento demo */ }
      }
    }

    const numberFormatter = new Intl.NumberFormat('es-UY');
    const moneyFormatter = new Intl.NumberFormat('es-UY',{style:'currency',currency:'UYU',maximumFractionDigits:0});
    const timestampFormatter = new Intl.DateTimeFormat('es-UY',{dateStyle:'short',timeStyle:'short'});
    const dateFormatter = new Intl.DateTimeFormat('es-UY',{dateStyle:'medium'});
    const monthFormatter = new Intl.DateTimeFormat('es-UY',{month:'long',year:'numeric'});

    const escapeHtml = (str='')=> String(str).replace(/[&<>"']/g, (c)=>({
      '&':'&amp;',
      '<':'&lt;',
      '>':'&gt;',
      '"':'&quot;',
      "'":'&#39;'
    })[c]);
    const toNumber = (value)=> Number(String(value||'').replace(/[^\d.,-]/g,'').replace('.','').replace(',','.')) || 0;
    const todayYMD = ()=>{
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    };
    const currentMonth = ()=> todayYMD().slice(0,7);
    const formatDateHuman = (ymd)=>{
      if(!ymd) return '';
      const [y,m,d] = ymd.split('-').map(part=>Number(part));
      if(!y || !m || !d) return '';
      return dateFormatter.format(new Date(y, m-1, d));
    };
    const formatMonth = (ym)=>{
      if(!ym) return '';
      const [y,m] = ym.split('-').map(part=>Number(part));
      if(!y || !m) return '';
      return monthFormatter.format(new Date(y, m-1, 1));
    };
    const formatTimestamp = (ts)=> ts ? timestampFormatter.format(new Date(ts)) : '';
    const toMillis = (value)=>{
      if(!value && value !== 0){ return null; }
      if(typeof value === 'number'){ return value; }
      if(typeof value.toDate === 'function'){ return value.toDate().getTime(); }
      if(typeof value.seconds === 'number'){ return (value.seconds * 1000) + Math.floor((value.nanoseconds || 0) / 1e6); }
      return null;
    };

    const readCache = (key)=>{
      if(!localStore) return null;
      try{
        const raw = localStore.getItem(key);
        return raw ? JSON.parse(raw) : null;
      }catch(err){
        return null;
      }
    };

    const LAST_ACCESS_PREFIX = 'gs:lastAccess:';
    const HOME_REFRESH_TTL = 60 * 1000;
    let homeUserId = null;
    let homeOrganizationId = null;
    let homeFetchToken = 0;
    let homeLastRefresh = 0;
    let cachedDb = null;

    function updateHomeCard(key, payload={}){
      const card = homeCards[key];
      if(!card) return;
      const prev = homeCardState.get(key) || {};
      const next = Object.assign({}, prev);
      if(payload.value !== undefined && card.value){
        if(prev.value !== payload.value){
          card.value.textContent = payload.value;
          next.value = payload.value;
        }
      }
      if(payload.meta !== undefined && card.meta){
        if(prev.meta !== payload.meta){
          card.meta.textContent = payload.meta;
          next.meta = payload.meta;
        }
      }
      if(next.value !== prev.value || next.meta !== prev.meta){
        homeCardState.set(key, next);
      }
    }

    function resetHomeCards(){
      Object.entries(HOME_DEFAULTS).forEach(([key,state])=> updateHomeCard(key, state));
    }

    function applyHomeCache(uid){
      if(!uid) return;
      const orgId = (window.gsAuth && typeof gsAuth.getOrganizationId === 'function')
        ? gsAuth.getOrganizationId()
        : 'default';
      const retiros = readCache(`gs:retiros:agenda:${uid}:${orgId}`) || readCache(`gs:retiros:agenda:${uid}`);
      if(retiros && Array.isArray(retiros.items)){
        setHomeData('retiros', summarizeRetiros({
          items: retiros.items,
          fecha: retiros.fecha,
          updatedAt: retiros.updatedAt
        }, { fromCache: true }));
      }

      const clientes = readCache(`gs:clientes:${uid}:${orgId}`) || readCache(`gs:clientes:${uid}`);
      if(clientes && (Array.isArray(clientes.data) || Array.isArray(clientes.list))){
        setHomeData('clientes', summarizeClientes(clientes, { fromCache: true }));
      }

      const pagos = readCache(`gs:finanzas:pagos:${uid}:${orgId}`) || readCache(`gs:finanzas:pagos:${uid}`);
      if(pagos && Array.isArray(pagos.items)){
        setHomeData('pagos', summarizePagos(pagos, { fromCache: true }));
      }
    }

    function updateLastAccessCard(uid, profile){
      if(!uid){
        updateHomeCard('acceso', { value: '‚Äî', meta: HOME_DEFAULTS.acceso.meta });
        return;
      }
      const now = Date.now();
      const profileTs = toMillis(profile && profile.lastAccessAt);
      let previousLocal = null;
      if(localStore){
        try{ previousLocal = localStore.getItem(LAST_ACCESS_PREFIX + uid); }
        catch(err){ previousLocal = null; }
        try{ localStore.setItem(LAST_ACCESS_PREFIX + uid, String(now)); }
        catch(err){ /* sin almacenamiento */ }
      }
      const previousTs = previousLocal && !Number.isNaN(Number(previousLocal)) ? Number(previousLocal) : null;
      if(profileTs && previousTs){
        updateHomeCard('acceso', {
          value: formatTimestamp(previousTs) || '‚Äî',
          meta: `Nube: ${formatTimestamp(profileTs)} ¬∑ Sesi√≥n actual: ${formatTimestamp(now)}`
        });
      }else if(profileTs){
        updateHomeCard('acceso', {
          value: formatTimestamp(profileTs) || '‚Äî',
          meta: `Sesi√≥n actual: ${formatTimestamp(now)}`
        });
      }else if(previousTs){
        updateHomeCard('acceso', {
          value: formatTimestamp(previousTs) || '‚Äî',
          meta: `Sesi√≥n actual: ${formatTimestamp(now)}`
        });
      }else{
        updateHomeCard('acceso', {
          value: 'Primer acceso',
          meta: `Sesi√≥n actual: ${formatTimestamp(now)}`
        });
      }
    }

    function getDb(){
      if(cachedDb){ return cachedDb; }
      if(typeof firebase === 'undefined' || typeof firebase.firestore !== 'function'){ return null; }
      cachedDb = firebase.firestore();
      return cachedDb;
    }

    function applyDemoHomeData(){
      if(!gsAuth || typeof gsAuth.getDemoData !== 'function'){ return; }
      const dataset = gsAuth.getDemoData();
      const now = Date.now();
      if(dataset && dataset.retiros){
        setHomeData('retiros', summarizeRetiros({
          items: Array.isArray(dataset.retiros.items) ? dataset.retiros.items : [],
          fecha: dataset.retiros.fecha || todayYMD(),
          updatedAt: now
        }, { fromCache: true }));
      }
      if(dataset && (Array.isArray(dataset.clientes))){
        setHomeData('clientes', summarizeClientes({
          data: dataset.clientes,
          updatedAt: now
        }, { fromCache: true }));
      }
      if(dataset && dataset.pagos){
        setHomeData('pagos', summarizePagos({
          items: Array.isArray(dataset.pagos.items) ? dataset.pagos.items : [],
          mes: dataset.pagos.mes || currentMonth(),
          updatedAt: now
        }, { fromCache: true }));
      }
      const homeSnapshot = dataset && dataset.home ? dataset.home : {};
      const lastAccess = homeSnapshot.ultimoAcceso ? Date.parse(homeSnapshot.ultimoAcceso) : now;
      updateHomeCard('acceso', {
        value: formatTimestamp(lastAccess),
        meta: 'Demo de solo lectura'
      });
    }

    function requestHomeRefresh(force=false){
      if(gsAuth && typeof gsAuth.isDemoSession === 'function' && gsAuth.isDemoSession()){
        applyDemoHomeData();
        return;
      }
      if(!homeUserId) return;
      const orgId = (window.gsAuth && typeof gsAuth.getOrganizationId === 'function')
        ? gsAuth.getOrganizationId()
        : 'default';
      if(homeOrganizationId !== orgId){
        homeOrganizationId = orgId;
        fetchHomeKpis(homeUserId, orgId);
        return;
      }
      const now = Date.now();
      if(force || !homeLastRefresh || (now - homeLastRefresh) > HOME_REFRESH_TTL){
        fetchHomeKpis(homeUserId, homeOrganizationId);
      }
    }

    async function fetchHomeKpis(uid, organizationId){
      const db = getDb();
      if(!db || !uid) return;
      const orgId = organizationId
        || ((window.gsAuth && typeof gsAuth.getOrganizationId === 'function') ? gsAuth.getOrganizationId() : 'default');
      if(!orgId){ return; }
      const token = ++homeFetchToken;

      updateHomeCard('retiros', { meta: 'Sincronizando agenda de hoy‚Ä¶' });
      updateHomeCard('agenda', { meta: 'Calculando progreso de retiros‚Ä¶' });
      updateHomeCard('ruta', { meta: 'Estimando facturaci√≥n de los retiros programados‚Ä¶' });
      updateHomeCard('clientes', { meta: 'Sincronizando cartera de clientes‚Ä¶' });
      updateHomeCard('clientesAlert', { meta: 'Identificando cuentas a regularizar‚Ä¶' });
      updateHomeCard('cobros', { meta: 'Sincronizando finanzas del mes‚Ä¶' });
      updateHomeCard('cobrosProgreso', { meta: 'Calculando avance de cobranzas‚Ä¶' });

      const today = todayYMD();
      const mes = currentMonth();
      const now = Date.now();

      const [retirosRes, clientesRes, pagosRes] = await Promise.allSettled([
        db.collection('retiros').where('organizationId','==',orgId).where('fecha','==',today).get(),
        db.collection('clientes').where('organizationId','==',orgId).get(),
        db.collection('pagos').where('organizationId','==',orgId).where('mes','==',mes).get()
      ]);

      if(token !== homeFetchToken) return;

      if(retirosRes.status === 'fulfilled'){
        const snap = retirosRes.value;
        const items = snap.docs.map(doc=>{
          const data = doc.data() || {};
          return {
            id: doc.id,
            clienteId: data.clienteId || data.cliente || '',
            estado: (data.estado || '').toLowerCase(),
            monto: data.monto || ''
          };
        });
        setHomeData('retiros', summarizeRetiros({
          items,
          fecha: today,
          updatedAt: now
        }));
      }else{
        updateHomeCard('retiros', { meta: 'No se pudo obtener la agenda. Reintent√° m√°s tarde.' });
        updateHomeCard('agenda', { meta: 'No pudimos calcular el progreso.' });
        updateHomeCard('ruta', { meta: 'No se pudo estimar la facturaci√≥n del d√≠a.' });
      }

      if(clientesRes.status === 'fulfilled'){
        const snap = clientesRes.value;
        const data = snap.docs.map(doc=>({ id: doc.id, ...doc.data() }));
        setHomeData('clientes', summarizeClientes({
          data,
          updatedAt: now
        }));
      }else{
        updateHomeCard('clientes', { meta: 'No se pudo obtener la cartera. Reintent√° m√°s tarde.' });
        updateHomeCard('clientesAlert', { meta: 'No pudimos analizar los contratos.' });
      }

      if(pagosRes.status === 'fulfilled'){
        const snap = pagosRes.value;
        const items = snap.docs.map(doc=>({ id: doc.id, ...doc.data() }));
        setHomeData('pagos', summarizePagos({
          items,
          mes,
          updatedAt: now
        }));
      }else{
        updateHomeCard('cobros', { meta: 'No se pudieron obtener los cobros. Reintent√° m√°s tarde.' });
        updateHomeCard('cobrosProgreso', { meta: 'No pudimos calcular la eficiencia de cobranza.' });
      }

      if(token === homeFetchToken){
        homeLastRefresh = Date.now();
      }
    }

    clearHomeData();
    resetHomeCards();


    // Login
    if(loginForm){
      loginForm.addEventListener('submit', async (event)=>{
        event.preventDefault();
        if(!emailInput || !passInput){ return; }
        const emailValue = emailInput.value.trim();
        const passwordValue = passInput.value.trim();
        if(!emailValue || !passwordValue){
          msg.textContent = '‚ö†Ô∏è Complet√° correo y contrase√±a.';
          return;
        }
        if(btnLogin){
          btnLogin.disabled = true;
          btnLogin.textContent = 'Entrando‚Ä¶';
        }
        msg.textContent = 'Verificando credenciales‚Ä¶';
        try{
          await gsAuth.signInWithEmailAndPassword(emailValue, passwordValue);
          msg.textContent = '‚úÖ Sesi√≥n iniciada';
        }catch(e){
          const friendly = (gsAuth && typeof gsAuth.describeError === 'function')
            ? gsAuth.describeError(e)
            : null;
          msg.textContent = '‚ùå ' + (friendly || e?.message || 'Error de login');
          if(e && e.code === 'auth/operation-not-allowed'){
            msg.innerHTML += '<br><small>Agreg√° este dominio en Firebase Auth ‚Üí Settings ‚Üí Authorized domains o prob√° el modo demo.</small>';
          }
        }finally{
          if(btnLogin){
            btnLogin.disabled = false;
            btnLogin.textContent = 'Entrar';
          }
        }
      });
    }

    // Logout
    $('#btnLogout').onclick = async ()=>{
      const redirectMode = (typeof gsAuth !== 'undefined' && gsAuth && typeof gsAuth.isDemoSession === 'function' && gsAuth.isDemoSession()) ? 'demo' : 'full';
      try{
        await gsAuth.signOut();
        ensureLandingRedirect(redirectMode);
      }catch(e){
        alert(e?.message || e);
      }
    };

    // Router simple por hash
    function ensureRouteAllowed(){
      const hash = location.hash || '#/';
      const key = hash.replace('#','');
      const route = routes[key];
      if(route && route.permission && !(sessionAbilities && sessionAbilities[route.permission])){
        if(hash !== '#/'){
          location.hash = '#/';
        }
        return false;
      }
      return true;
    }

    function setActive(hash){
      if(!sideNav) return;
      [...sideNav.querySelectorAll('a')].forEach(a=> a.classList.toggle('active', a.getAttribute('href') === hash));
    }

    function navigate(){
      // normalizar
      let hash = location.hash || '#/';
      const key = hash.replace('#','');
      let route = routes[key] || routes['/'];
      if(route && route.permission && !(sessionAbilities && sessionAbilities[route.permission])){
        if(hash !== '#/'){
          location.hash = '#/';
          return;
        }
        route = routes['/'];
        hash = '#/';
      }

      const label = getModuleLabel(route.moduleKey) || route.defaultTitle || '';
      if(pageTitle){
        pageTitle.textContent = label;
      }
      const subtitle = route.subtitle || (route.page
        ? 'Tu sesi√≥n sigue activa, cargamos el m√≥dulo seleccionado en este panel.'
        : routes['/'].subtitle);
      if(pageSubtitle){
        pageSubtitle.textContent = subtitle;
      }
      setActive(hash);

      if(route.page){
        homeView.classList.add('hidden');
        const iframe = ensureModuleFrame(route.page, label);
        if(!iframe){
          showLoader(`Abriendo ${label}`, 'Sincronizando datos con tu sesi√≥n.');
          return;
        }
        hideModuleFrames(iframe);
        iframe.classList.remove('hidden');
        iframe.setAttribute('aria-hidden', 'false');
        iframe.removeAttribute('tabindex');
        activeFrame = iframe;
        const currentSrc = iframe.getAttribute('src');
        const isLoaded = iframe.dataset.loaded === 'true';
        if(currentSrc !== route.page){
          showLoader(`Abriendo ${label}`, 'Sincronizando datos con tu sesi√≥n.');
          iframe.dataset.loaded = '';
          iframe.classList.remove('loaded');
          iframe.setAttribute('src', route.page);
        }else if(!isLoaded){
          showLoader(`Abriendo ${label}`, 'Sincronizando datos con tu sesi√≥n.');
          iframe.classList.remove('loaded');
          if(!currentSrc){
            iframe.setAttribute('src', route.page);
          }
        }else{
          hideLoader();
        }
      }else{
        activeFrame = null;
        hideModuleFrames();
        homeView.classList.remove('hidden');
        hideLoader();
        hideModuleError();
        requestHomeRefresh();
      }

      try{ localStorage.setItem(STORAGE_KEY, route === routes['/'] ? '/' : key); }
      catch(err){ /* almacenamiento no disponible */ }
    }
    window.addEventListener('hashchange', navigate);

    function showLoader(title, subtitle){
      const defaultTitle = `${getActiveBrandName()} ¬∑ Cargando`;
      const defaultSubtitle = 'Sincronizando la vista con tu sesi√≥n.';
      if(viewerLoading){
        viewerLoading.classList.remove('hidden');
      }
      if(viewerLoadingTitle){
        viewerLoadingTitle.textContent = title || defaultTitle;
      }
      if(viewerLoadingText){
        viewerLoadingText.textContent = subtitle || defaultSubtitle;
      }
      hideModuleError();
    }
    function hideLoader(){
      const defaultTitle = `${getActiveBrandName()} ¬∑ Cargando`;
      const defaultSubtitle = 'Sincronizando la vista con tu sesi√≥n.';
      if(viewerLoading){
        viewerLoading.classList.add('hidden');
      }
      if(viewerLoadingTitle){
        viewerLoadingTitle.textContent = defaultTitle;
      }
      if(viewerLoadingText){
        viewerLoadingText.textContent = defaultSubtitle;
      }
    }

    // Bandeja com√∫n para cuando un iframe falla antes del despliegue final.
    function hideModuleError(){
      if(viewerError){
        viewerError.classList.add('hidden');
      }
    }

    function showModuleError(label, detail){
      if(!viewerError) return;
      if(viewerErrorTitle){
        viewerErrorTitle.textContent = `No pudimos abrir ${label}.`;
      }
      if(viewerErrorText){
        viewerErrorText.textContent = detail || 'Revis√° tu conexi√≥n y volv√© a intentar.';
      }
      viewerError.classList.remove('hidden');
      hideLoader();
    }

    // Permite reintentar r√°pidamente la vista actual sin recargar toda la app.
    function reloadActiveModule(){
      if(!activeFrame) return;
      const src = activeFrame.getAttribute('src') || activeFrame.dataset.page || '';
      if(!src) return;
      const pageLabel = activeFrame.dataset.pageLabel || 'el m√≥dulo';
      showLoader(`Reintentando ${pageLabel}`, 'Actualizando la vista publicada‚Ä¶');
      const [path, hash] = src.split('#');
      const sanitized = (path || '').replace(/([?&])gsReload=\d+/g, '').replace(/([?&])$/, '');
      const base = sanitized || path || '';
      if(!base) return;
      const connector = base.includes('?') ? '&' : '?';
      const nextSrc = `${base}${connector}gsReload=${Date.now()}${hash ? `#${hash}` : ''}`;
      activeFrame.dataset.loaded = '';
      activeFrame.classList.remove('loaded');
      activeFrame.setAttribute('src', nextSrc);
    }

    function closeNav(){
      document.body.classList.remove('nav-open');
      if(navToggle){
        navToggle.setAttribute('aria-expanded','false');
        navToggle.setAttribute('aria-label','Abrir men√∫');
      }
      if(navBackdrop){ navBackdrop.hidden = true; }
    }
    function openNav(){
      document.body.classList.add('nav-open');
      if(navToggle){ navToggle.setAttribute('aria-expanded','true'); navToggle.setAttribute('aria-label','Cerrar men√∫'); }
      if(navBackdrop){ navBackdrop.hidden = false; }
    }

    if(navToggle){
      navToggle.addEventListener('click', ()=>{
        const expanded = navToggle.getAttribute('aria-expanded') === 'true';
        if(expanded){
          closeNav();
          navToggle.setAttribute('aria-label','Abrir men√∫');
        }else{
          openNav();
        }
      });
    }

    if(navBackdrop){
      navBackdrop.addEventListener('click', closeNav);
    }

    sideNav.addEventListener('click', (event)=>{
      const link = event.target.closest('a');
      if(link){
        const external = link.dataset.external;
        closeNav();
        navToggle?.setAttribute('aria-label','Abrir men√∫');
        if(external){
          event.preventDefault();
          window.location.href = external;
        }
      }
    });

    window.addEventListener('resize', ()=>{
      if(window.innerWidth > 1024){
        closeNav();
        navToggle?.setAttribute('aria-label','Abrir men√∫');
      }
    });

    document.addEventListener('keydown',(event)=>{
      if(event.key === 'Escape' && document.body.classList.contains('nav-open')){
        closeNav();
        navToggle?.focus();
      }
    });

    function labelForRole(role, context){
      const key = normalizeRole(role, context);
      return ROLE_LABELS[key] || ROLE_LABELS.guest || 'Invitado';
    }

    function applyBodyRole(role, context){
      if(document && document.body){
        document.body.setAttribute('data-role', normalizeRole(role, context) || 'guest');
      }
    }

    function updateSessionChipDisplay(session){
      if(!sessionChip || !sessionRole || !sessionEmail) return;
      const user = session && session.user;
      const role = normalizeRole(session && session.role, user);
      const status = session ? session.status : 'signed-out';
      const isActive = !!user && (status === 'authenticated' || status === 'restoring');
      if(isActive){
        sessionChip.classList.remove('hidden');
        sessionChip.dataset.role = role || 'guest';
        sessionRole.textContent = labelForRole(role, user);
        sessionEmail.textContent = user.email || 'Sin correo registrado';
      }else{
        sessionChip.classList.add('hidden');
        sessionChip.dataset.role = 'guest';
        sessionRole.textContent = labelForRole('guest');
        sessionEmail.textContent = 'Sin sesi√≥n activa';
      }
    }

    function applyNavPermissions(){
      navLinksWithPermission.forEach((link)=>{
        const perm = link.dataset.permission;
        const allowed = !perm || !!(sessionAbilities && sessionAbilities[perm]);
        if(allowed){
          link.classList.remove('hidden');
          link.setAttribute('aria-hidden', 'false');
          link.removeAttribute('tabindex');
        }else{
          link.classList.add('hidden');
          link.setAttribute('aria-hidden', 'true');
          link.setAttribute('tabindex', '-1');
        }
      });
    }

    function handleLogin(session){
      const uid = session && session.user ? (session.user.uid || 'default') : 'default';
      homeFetchToken += 1;
      homeLastRefresh = 0;
      homeUserId = uid;
      homeOrganizationId = session && session.profile && session.profile.organizationId
        ? session.profile.organizationId
        : ((window.gsAuth && typeof gsAuth.getOrganizationId === 'function') ? gsAuth.getOrganizationId() : 'default');
      clearHomeData();
      resetHomeCards();
      applyHomeCache(uid);
      updateLastAccessCard(uid, session ? session.profile : null);
      document.body.classList.remove('login-open');
      if(landingShell){ landingShell.removeAttribute('aria-hidden'); }
      if(loginView){ loginView.classList.add('hidden'); }
      if(appView){ appView.classList.remove('hidden'); }
      document.body.classList.add('app-ready');
      if(emailInput && session && session.user && session.user.email){
        emailInput.value = session.user.email;
      }
      if(passInput){ passInput.value = ''; }
      requestHomeRefresh(true);
      if(!location.hash){
        let initialHash = '#/';
        try{
          const saved = localStorage.getItem(STORAGE_KEY);
          if(saved && routes[saved]){ initialHash = `#${saved}`; }
        }catch(err){ /* sin almacenamiento */ }
        location.hash = initialHash;
      }else{
        navigate();
      }
    }

    function handleLogout(){
      homeUserId = null;
      homeOrganizationId = null;
      homeLastRefresh = 0;
      homeFetchToken += 1;
      clearHomeData();
      resetHomeCards();
      document.body.classList.add('login-open');
      if(appView){ appView.classList.add('hidden'); }
      if(loginView){ loginView.classList.remove('hidden'); }
      if(landingShell){ landingShell.removeAttribute('aria-hidden'); }
      document.body.classList.remove('app-ready');
      document.body.setAttribute('data-role','guest');
      cancelModuleWarmup();
      resetModuleFrames();
      hideLoader();
      hideModuleError();
      closeNav();
      navToggle?.setAttribute('aria-label','Abrir men√∫');
      try{ localStorage.removeItem(STORAGE_KEY); }catch(err){ /* noop */ }
      if(sessionChip){
        sessionChip.classList.add('hidden');
        sessionChip.dataset.role = 'guest';
      }
      if(emailInput){ emailInput.value = ''; }
      if(passInput){ passInput.value = ''; }
      lastProfileStamp = null;
      appInitializedFor = null;
    }

    gsAuth.onSession((session)=>{
      currentSession = session;
      const role = normalizeRole(session && session.role, session && session.user);
      applyBodyRole(role, session && session.user);
      sessionAbilities = session && session.abilities ? session.abilities : {};
      applyNavPermissions();
      ensureRouteAllowed();
      updateSessionChipDisplay(session);
      if(session && session.user && emailInput && !emailInput.value){
        emailInput.value = session.user.email || '';
      }

      const status = session ? session.status : 'signed-out';
      const isAuthenticated = !!(session && session.user) && (status === 'authenticated' || status === 'demo');
      const uid = isAuthenticated && session.user ? (session.user.uid || 'default') : null;
      document.body.classList.toggle('demo-mode', status === 'demo');

      if(isAuthenticated){
        const profileStamp = toMillis(session.profile && session.profile.lastAccessAt);
        if(appInitializedFor !== uid){
          appInitializedFor = uid;
          handleLogin(session);
        }
        scheduleModuleWarmup();
        if(profileStamp && profileStamp !== lastProfileStamp){
          lastProfileStamp = profileStamp;
          updateLastAccessCard(uid, session.profile);
        }else if(!profileStamp && uid){
          updateLastAccessCard(uid, session.profile);
        }
      }else{
        cancelModuleWarmup();
        if(lastSession && lastSession.user && (lastSession.status === 'authenticated' || lastSession.status === 'demo')){
          handleLogout();
          const previousMode = (lastSession && lastSession.status === 'demo') ? 'demo' : 'full';
          ensureLandingRedirect(previousMode);
        }
      }

      lastSession = session;
    });

    if(viewerErrorRetry){
      viewerErrorRetry.addEventListener('click', ()=>{
        hideModuleError();
        reloadActiveModule();
      });
    }

    if(viewerErrorHome){
      viewerErrorHome.addEventListener('click', ()=>{
        hideModuleError();
        location.hash = '#/';
      });
    }

    // ========================================
    // EXECUTIVE COMMAND CENTER
    // ========================================
    
    // Variables globales del dashboard
    let dashboardCharts = {};
    let currentPeriod = 'today';
    let refreshInterval;
    let alertCheckInterval;
    
    // Configuraci√≥n de colores del tema din√°mico - SE LEEN DE LA APLICACI√ìN ACTUAL
    let currentTheme = {
        primary: getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#1DBF73',
        secondary: getComputedStyle(document.documentElement).getPropertyValue('--accent2') || '#16a062', 
        accent: getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#1DBF73'
    };
    
    // ========================================
    // INICIALIZACI√ìN DEL DASHBOARD
    // ========================================
    
    document.addEventListener('DOMContentLoaded', function() {
        initializeDashboard();
        setupThemeListener();
        setupPeriodSelector();
        setupKeyboardNavigation();
        startDataRefresh();
        startAlertMonitoring();
    });
    
    // ========================================
    // INICIALIZACI√ìN PRINCIPAL
    // ========================================
    
    function initializeDashboard() {
        console.log('üöÄ Inicializando Executive Command Center...');
        
        // Detectar y usar colorimetr√≠a existente de la aplicaci√≥n
        detectExistingTheme();
        
        // Aplicar tema din√°mico (solo si hay cambios reales)
        applyDynamicTheme();
        
        // Configurar per√≠odo por defecto
        setCurrentPeriod('today');
        
        // Cargar datos iniciales
        loadAllKPIData();
        
        console.log('‚úÖ Executive Command Center inicializado correctamente');
        
        // Inicializar AI Intelligence Layer
        initializeAIIntelligence();
    }
    
    // ========================================
    // DETECCI√ìN AUTOM√ÅTICA DE TEMAS EXISTENTES
    // ========================================
    
    function detectExistingTheme() {
        console.log('üé® Detectando esquema de colores existente...');
        
        const rootStyle = getComputedStyle(document.documentElement);
        
        // Intentar leer colores existentes en orden de prioridad
        const existingColors = {
            primary: rootStyle.getPropertyValue('--accent')?.trim() ||
                    rootStyle.getPropertyValue('--color-primary')?.trim() ||
                    rootStyle.getPropertyValue('--primary-color')?.trim() ||
                    getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#1DBF73',
                    
            secondary: rootStyle.getPropertyValue('--accent2')?.trim() ||
                      rootStyle.getPropertyValue('--color-secondary')?.trim() ||
                      rootStyle.getPropertyValue('--secondary-color')?.trim() ||
                      getComputedStyle(document.documentElement).getPropertyValue('--accent2') || '#16a062',
                      
            accent: rootStyle.getPropertyValue('--accent-color')?.trim() ||
                   rootStyle.getPropertyValue('--color-accent')?.trim() ||
                   rootStyle.getPropertyValue('--accent')?.trim() ||
                   getColorFromCSSRule('accent')
        };
        
        // Si encontramos colores existentes, usarlos
        if (existingColors.primary || existingColors.secondary || existingColors.accent) {
            currentTheme = {
                primary: existingColors.primary || currentTheme.primary,
                secondary: existingColors.secondary || currentTheme.secondary,
                accent: existingColors.accent || currentTheme.accent
            };
            console.log('üé® Colores detectados del tema existente:', currentTheme);
        } else {
            console.log('üé® Usando colores por defecto:', currentTheme);
        }
    }
    
    // ========================================
    // DETECCI√ìN DE COLORES DESDE REGLAS CSS
    // ========================================
    
    function getColorFromCSSRule(colorName) {
        try {
            // Crear un elemento temporal para probar colores
            const tempEl = document.createElement('div');
            tempEl.style.color = `var(--${colorName})`;
            document.body.appendChild(tempEl);
            
            const computedColor = getComputedStyle(tempEl).color;
            document.body.removeChild(tempEl);
            
            // Convertir rgb(a) a hex si es posible
            if (computedColor.startsWith('rgb')) {
                const rgb = computedColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)/);
                if (rgb) {
                    return `#${parseInt(rgb[1]).toString(16).padStart(2, '0')}${parseInt(rgb[2]).toString(16).padStart(2, '0')}${parseInt(rgb[3]).toString(16).padStart(2, '0')}`;
                }
            }
            
            return computedColor;
        } catch (err) {
            console.warn('Error detectando color:', colorName, err);
            return null;
        }
    }
    
    // ========================================
    // APLICACI√ìN DE TEMA DIN√ÅMICO
    // ========================================
    
    function applyDynamicTheme() {
        console.log('üé® Aplicando tema din√°mico...');
        
        // Actualizar variables CSS si existen
        const root = document.documentElement;
        
        // Usar los colores detectados del tema existente
        if (currentTheme.primary) {
            root.style.setProperty('--primary-color', currentTheme.primary);
            root.style.setProperty('--accent', currentTheme.primary);
        }
        
        if (currentTheme.secondary) {
            root.style.setProperty('--secondary-color', currentTheme.secondary);
            root.style.setProperty('--accent2', currentTheme.secondary);
        }
        
        if (currentTheme.accent) {
            root.style.setProperty('--accent-color', currentTheme.accent);
        }
        
        // Actualizar colores en las variables existentes
        if (currentTheme.primary) {
            root.style.setProperty('--app-accent', currentTheme.primary);
        }
        
        if (currentTheme.secondary) {
            root.style.setProperty('--app-secondary', currentTheme.secondary);
        }
        
        console.log('‚úÖ Tema din√°mico aplicado');
    }
    
    // ========================================
    // MONITOREO DE CAMBIOS DE TEMA
    // ========================================
    
    function setupThemeListener() {
        // Escuchar cambios en variables CSS
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    // Detectar cambios en variables CSS
                    detectExistingTheme();
                    applyDynamicTheme();
                }
            });
        });
        
        // Observar cambios en el elemento root
        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['style']
        });
        
        // Tambi√©n escuchar eventos de cambio de tema si est√°n disponibles
        if (typeof gsAuth !== 'undefined' && gsAuth.onTheme) {
            gsAuth.onTheme(function(theme) {
                console.log('üé® Cambiando tema via gsAuth:', theme);
                if (theme && theme.palette) {
                    detectExistingTheme();
                    applyDynamicTheme();
                }
            });
        }
    }
    
    // ========================================
    // CONFIGURACI√ìN DEL SELECTOR DE PER√çODOS
    // ========================================
    
    function setupPeriodSelector() {
        console.log('üìÖ Configurando selector de per√≠odos...');
        
        const periodButtons = document.querySelectorAll('.period-btn');
        
        periodButtons.forEach(button => {
            button.addEventListener('click', function() {
                const period = this.getAttribute('data-period');
                setCurrentPeriod(period);
                
                // Actualizar estado visual
                periodButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Recargar datos para el nuevo per√≠odo
                loadAllKPIData();
            });
        });
        
        console.log('‚úÖ Selector de per√≠odos configurado');
    }
    
    // ========================================
    // CONFIGURACI√ìN DE NAVEGACI√ìN POR TECLADO
    // ========================================
    
    function setupKeyboardNavigation() {
        console.log('‚å®Ô∏è Configurando navegaci√≥n por teclado...');
        
        document.addEventListener('keydown', function(e) {
            // Cerrar modal con Escape
            if (e.key === 'Escape') {
                closeDrilldownModal();
            }
            
            // Navegaci√≥n con n√∫meros 1-9 para cambiar per√≠odo
            if (e.key >= '1' && e.key <= '9') {
                const periodIndex = parseInt(e.key) - 1;
                const periods = ['today', 'week', 'month', 'quarter', 'year'];
                if (periods[periodIndex]) {
                    setCurrentPeriod(periods[periodIndex]);
                    loadAllKPIData();
                    
                    // Actualizar estado visual
                    document.querySelectorAll('.period-btn').forEach((btn, index) => {
                        btn.classList.toggle('active', index === periodIndex);
                    });
                }
            }
        });
        
        console.log('‚úÖ Navegaci√≥n por teclado configurada');
    }
    
    // ========================================
    // GESTI√ìN DE PER√çODOS
    // ========================================
    
    function setCurrentPeriod(period) {
        currentPeriod = period;
        console.log(`üìÖ Per√≠odo cambiado a: ${period}`);
        
        // Actualizar t√≠tulo del dashboard seg√∫n el per√≠odo
        const dashboardTitle = document.querySelector('.dashboard-title');
        if (dashboardTitle) {
            const periodNames = {
                'today': 'Hoy',
                'week': 'Esta Semana',
                'month': 'Este Mes',
                'quarter': 'Este Trimestre',
                'year': 'Este A√±o'
            };
            dashboardTitle.textContent = `Executive Command Center - ${periodNames[period] || 'Dashboard'}`;
        }
    }
    
    // ========================================
    // CARGA DE DATOS DE KPIS
    // ========================================
    
    function loadAllKPIData() {
        console.log(`üìä Cargando datos de KPIs para per√≠odo: ${currentPeriod}`);
        
        // Mostrar estado de carga
        showLoadingState();
        
        // Cargar cada KPI con un delay para simular carga real
        loadKPI('retiros').then(() => {
            return loadKPI('ingresos');
        }).then(() => {
            return loadKPI('eficiencia');
        }).then(() => {
            hideLoadingState();
            console.log('‚úÖ Todos los KPIs cargados');
        }).catch(error => {
            console.error('‚ùå Error cargando KPIs:', error);
            hideLoadingState();
        });
    }
    
    function showLoadingState() {
        // Mostrar indicadores de carga en las cards
        document.querySelectorAll('.kpi-value').forEach(el => {
            el.textContent = '‚Äî';
            el.style.opacity = '0.5';
        });
    }
    
    function hideLoadingState() {
        // Ocultar indicadores de carga
        document.querySelectorAll('.kpi-value').forEach(el => {
            el.style.opacity = '1';
        });
    }
    
    // ========================================
    // CARGA DE DATOS POR KPI
    // ========================================
    
    async function loadKPI(kpiType) {
        console.log(`üìä Cargando KPI: ${kpiType}`);
        
        try {
            const data = await fetchKPIData(kpiType);
            updateKPICard(kpiType, data);
            createOrUpdateChart(kpiType, data);
            return data;
        } catch (error) {
            console.error(`‚ùå Error cargando KPI ${kpiType}:`, error);
            // Mostrar datos de fallback
            showKPIFallback(kpiType);
            return null;
        }
    }
    
    function showKPIFallback(kpiType) {
        const fallbackData = {
            'retiros': { value: '0', change: '+0%', trend: 'neutral' },
            'ingresos': { value: '$0', change: '+0%', trend: 'neutral' },
            'eficiencia': { value: '0%', change: '+0%', trend: 'neutral' }
        };
        
        const data = fallbackData[kpiType] || fallbackData['retiros'];
        updateKPICard(kpiType, data);
    }
    
    // ========================================
    // ACTUALIZACI√ìN DE CARDS DE KPI
    // ========================================
    
    function updateKPICard(kpiType, data) {
        console.log(`üìä Actualizando card: ${kpiType}`, data);
        
        const valueEl = document.getElementById(`${kpiType}Value`);
        const changeEl = document.getElementById(`${kpiType}ChangeValue`);
        const changeContainer = document.getElementById(`${kpiType}Change`);
        
        if (valueEl) {
            valueEl.textContent = data.value || '‚Äî';
        }
        
        if (changeEl) {
            changeEl.textContent = data.change || '‚Äî';
        }
        
        if (changeContainer) {
            changeContainer.className = `kpi-change ${data.trend || 'neutral'}`;
        }
    }
    
    // ========================================
    // CREACI√ìN Y ACTUALIZACI√ìN DE GR√ÅFICOS
    // ========================================
    
    function createOrUpdateChart(kpiType, data) {
        const canvasId = `${kpiType}Chart`;
        const canvas = document.getElementById(canvasId);
        
        if (!canvas) {
            console.warn(`‚ö†Ô∏è Canvas no encontrado: ${canvasId}`);
            return;
        }
        
        // Destruir gr√°fico existente si existe
        if (dashboardCharts[kpiType]) {
            dashboardCharts[kpiType].destroy();
        }
        
        // Configurar datos del gr√°fico
        const chartData = getChartDataForKPI(kpiType, data);
        
        // Crear nuevo gr√°fico
        const ctx = canvas.getContext('2d');
        dashboardCharts[kpiType] = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        display: false
                    },
                    y: {
                        display: false
                    }
                },
                elements: {
                    point: {
                        radius: 3,
                        hoverRadius: 5
                    },
                    line: {
                        borderWidth: 2,
                        tension: 0.3
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }
    
    function getChartDataForKPI(kpiType, data) {
        // Datos de muestra para los gr√°ficos
        const sampleData = {
            'retiros': {
                labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
                datasets: [{
                    label: 'Retiros',
                    data: [12, 19, 8, 15, 25, 22, 18],
                    borderColor: currentTheme.accent || '#1DBF73',
                    backgroundColor: (currentTheme.accent || '#1DBF73') + '20',
                    fill: true
                }]
            },
            'ingresos': {
                labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
                datasets: [{
                    label: 'Ingresos',
                    data: [2500, 3200, 1800, 4100, 5300, 4800, 3600],
                    borderColor: currentTheme.accent || '#1DBF73',
                    backgroundColor: (currentTheme.accent || '#1DBF73') + '20',
                    fill: true
                }]
            },
            'eficiencia': {
                labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
                datasets: [{
                    label: 'Eficiencia',
                    data: [85, 92, 78, 88, 95, 89, 91],
                    borderColor: currentTheme.accent || '#1DBF73',
                    backgroundColor: (currentTheme.accent || '#1DBF73') + '20',
                    fill: true
                }]
            }
        };
        
        return sampleData[kpiType] || sampleData['retiros'];
    }
    
    // ========================================
    // OBTENCI√ìN DE DATOS DESDE FIREBASE
    // ========================================
    
    async function fetchKPIData(kpiType) {
        console.log(`üîÑ Obteniendo datos de Firebase para: ${kpiType}`);
        
        // Simular delay de red
        await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 500));
        
        // Intentar obtener datos de Firebase si est√° disponible
        if (typeof db !== 'undefined' && db) {
            try {
                return await fetchRealKPIFromFirebase(kpiType);
            } catch (error) {
                console.warn('‚ö†Ô∏è Error obteniendo datos de Firebase:', error);
                return generateSampleKPIData(kpiType);
            }
        } else {
            console.log('üìä Firebase no disponible, usando datos de muestra');
            return generateSampleKPIFromLocalStorage(kpiType);
        }
    }
    
    async function fetchRealKPIFromFirebase(kpiType) {
        const data = {};
        
        switch (kpiType) {
            case 'retiros':
                const retirosSnapshot = await db.collection('retiros')
                    .where('fecha', '>=', getPeriodStartDate())
                    .get();
                data.value = retirosSnapshot.size.toString();
                data.change = '+12% vs anterior';
                data.trend = 'positive';
                break;
                
            case 'ingresos':
                const pagosSnapshot = await db.collection('pagos')
                    .where('fecha', '>=', getPeriodStartDate())
                    .get();
                const totalIngresos = pagosSnapshot.docs.reduce((sum, doc) => {
                    const pago = doc.data();
                    return sum + (pago.monto || 0);
                }, 0);
                data.value = formatCurrency(totalIngresos);
                data.change = '+8% vs anterior';
                data.trend = 'positive';
                break;
                
            case 'eficiencia':
                const clientesSnapshot = await db.collection('clientes').get();
                const totalClientes = clientesSnapshot.size;
                const clientesActivos = clientesSnapshot.docs.filter(doc => {
                    const cliente = doc.data();
                    return cliente.contrato && cliente.activo !== false;
                }).length;
                const eficiencia = totalClientes > 0 ? Math.round((clientesActivos / totalClientes) * 100) : 0;
                data.value = `${eficiencia}%`;
                data.change = '+5% vs anterior';
                data.trend = 'positive';
                break;
        }
        
        return data;
    }
    
    function getPeriodStartDate() {
        const now = new Date();
        
        switch (currentPeriod) {
            case 'today':
                return new Date(now.getFullYear(), now.getMonth(), now.getDate());
            case 'week':
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - now.getDay());
                return weekStart;
            case 'month':
                return new Date(now.getFullYear(), now.getMonth(), 1);
            case 'quarter':
                const quarter = Math.floor(now.getMonth() / 3);
                return new Date(now.getFullYear(), quarter * 3, 1);
            case 'year':
                return new Date(now.getFullYear(), 0, 1);
            default:
                return new Date(now.getFullYear(), now.getMonth(), now.getDate());
        }
    }
    
    function generateSampleKPIFromLocalStorage(kpiType) {
        // Intentar obtener datos del localStorage
        const storedData = localStorage.getItem(`kpi_${kpiType}_${currentPeriod}`);
        if (storedData) {
            try {
                return JSON.parse(storedData);
            } catch (error) {
                console.warn('‚ö†Ô∏è Error parseando datos del localStorage:', error);
            }
        }
        
        // Generar datos de muestra
        return generateSampleKPIData(kpiType);
    }
    
    function generateSampleKPIData(kpiType) {
        const sampleData = {
            'retiros': {
                value: Math.floor(Math.random() * 50 + 10).toString(),
                change: `+${Math.floor(Math.random() * 20 + 5)}% vs anterior`,
                trend: Math.random() > 0.2 ? 'positive' : 'negative'
            },
            'ingresos': {
                value: formatCurrency(Math.floor(Math.random() * 50000 + 20000)),
                change: `+${Math.floor(Math.random() * 15 + 3)}% vs anterior`,
                trend: Math.random() > 0.15 ? 'positive' : 'negative'
            },
            'eficiencia': {
                value: `${Math.floor(Math.random() * 20 + 80)}%`,
                change: `+${Math.floor(Math.random() * 8 + 2)}% vs anterior`,
                trend: 'positive'
            }
        };
        
        const data = sampleData[kpiType] || sampleData['retiros'];
        
        // Guardar en localStorage para uso posterior
        try {
            localStorage.setItem(`kpi_${kpiType}_${currentPeriod}`, JSON.stringify(data));
        } catch (error) {
            console.warn('‚ö†Ô∏è No se pudo guardar en localStorage:', error);
        }
        
        return data;
    }
    
    function formatCurrency(amount) {
        return new Intl.NumberFormat('es-UY', {
            style: 'currency',
            currency: 'UYU',
            minimumFractionDigits: 0
        }).format(amount);
    }
    
    // ========================================
    // SISTEMA DE ALERTAS
    // ========================================
    
    function startAlertMonitoring() {
        console.log('üö® Iniciando monitoreo de alertas...');
        
        // Cargar alertas iniciales
        loadAlerts();
        
        // Configurar intervalos de verificaci√≥n
        alertCheckInterval = setInterval(() => {
            loadAlerts();
        }, 30000); // Verificar cada 30 segundos
        
        console.log('‚úÖ Monitoreo de alertas iniciado');
    }
    
    async function loadAlerts() {
        console.log('üîî Cargando alertas del sistema...');
        
        try {
            const alerts = await generateSystemAlerts();
            displayAlerts(alerts);
        } catch (error) {
            console.error('‚ùå Error cargando alertas:', error);
            displayAlerts([]);
        }
    }
    
    function displayAlerts(alerts) {
        const alertsContent = document.getElementById('alertsContent');
        if (!alertsContent) return;
        
        if (alerts.length === 0) {
            alertsContent.innerHTML = '<div class="alert-item"><div class="alert-icon">‚úÖ</div><div class="alert-content"><div class="alert-title">Sistema Operativo</div><div class="alert-time">Todos los sistemas funcionando correctamente</div></div></div>';
            return;
        }
        
        alertsContent.innerHTML = alerts.map(alert => `
            <div class="alert-item">
                <svg class="alert-icon" fill="currentColor">
                    <use href="#icon-alert"></use>
                </svg>
                <div class="alert-content">
                    <div class="alert-title">${alert.title}</div>
                    <div class="alert-time">${alert.time}</div>
                </div>
            </div>
        `).join('');
    }
    
    function generateSystemAlerts() {
        return new Promise(resolve => {
            // Simular carga de alertas desde Firebase
            setTimeout(() => {
                const alerts = [];
                
                // Alertas de muestra
                if (Math.random() > 0.7) {
                    alerts.push({
                        title: 'Retiros pendientes de confirmaci√≥n',
                        time: 'Hace 15 minutos'
                    });
                }
                
                if (Math.random() > 0.8) {
                    alerts.push({
                        title: 'Cliente sin contrato requiere atenci√≥n',
                        time: 'Hace 1 hora'
                    });
                }
                
                if (Math.random() > 0.9) {
                    alerts.push({
                        title: 'Cobro vencido detectado',
                        time: 'Hace 2 horas'
                    });
                }
                
                resolve(alerts);
            }, 500);
        });
    }
    
    // ========================================
    // REFRESH AUTOM√ÅTICO
    // ========================================
    
    function startDataRefresh() {
        console.log('üîÑ Iniciando refresh autom√°tico...');
        
        refreshInterval = setInterval(() => {
            console.log('üîÑ Refrescando datos autom√°ticamente...');
            loadAllKPIData();
            loadAlerts();
        }, 300000); // Refrescar cada 5 minutos
        
        console.log('‚úÖ Refresh autom√°tico iniciado');
    }
    
    function stopDataRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
            console.log('‚èπÔ∏è Refresh autom√°tico detenido');
        }
    }
    
    // ========================================
    // MODAL DE DETALLE (DRILLDOWN)
    // ========================================
    
    function setupDrilldownModal() {
        console.log('üìä Configurando modal de detalles...');
        
        // Configurar eventos de clic en las cards
        document.querySelectorAll('.kpi-card').forEach(card => {
            card.addEventListener('click', function() {
                const kpiType = this.getAttribute('data-kpi');
                const module = this.getAttribute('data-module');
                openDrilldownModal(kpiType, module);
            });
        });
        
        // Configurar bot√≥n de cerrar
        const closeBtn = document.getElementById('drilldownClose');
        if (closeBtn) {
            closeBtn.addEventListener('click', closeDrilldownModal);
        }
        
        // Cerrar al hacer clic fuera del contenido
        const modal = document.getElementById('drilldownModal');
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeDrilldownModal();
                }
            });
        }
        
        console.log('‚úÖ Modal de detalles configurado');
    }
    
    function openDrilldownModal(kpiType, module) {
        console.log(`üìä Abriendo modal para KPI: ${kpiType}`);
        
        const modal = document.getElementById('drilldownModal');
        const titleEl = document.getElementById('drilldownTitle');
        const bodyEl = document.getElementById('drilldownBody');
        
        if (!modal || !titleEl || !bodyEl) return;
        
        // Configurar t√≠tulo
        const kpiNames = {
            'retiros': 'Retiros Programados',
            'ingresos': 'Ingresos Diarios',
            'eficiencia': 'Eficiencia Operativa'
        };
        titleEl.textContent = kpiNames[kpiType] || 'Detalles del KPI';
        
        // Generar contenido detallado
        generateDetailedContent(kpiType, bodyEl);
        
        // Mostrar modal
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        
        // Enfocar el modal para accesibilidad
        modal.focus();
        
        console.log('‚úÖ Modal abierto');
    }
    
    function closeDrilldownModal() {
        console.log('üìä Cerrando modal');
        
        const modal = document.getElementById('drilldownModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }
    }
    
    function generateDetailedContent(kpiType, container) {
        // Generar contenido detallado seg√∫n el tipo de KPI
        const detailedContent = {
            'retiros': {
                summary: 'An√°lisis detallado de retiros programados',
                metrics: [
                    { label: 'Total Retiros', value: '147', change: '+12%' },
                    { label: 'Completados', value: '132', change: '+8%' },
                    { label: 'Pendientes', value: '15', change: '-5%' },
                    { label: 'Eficiencia', value: '89.8%', change: '+2.1%' }
                ],
                actions: [
                    'Ver agenda completa',
                    'Exportar reporte',
                    'Configurar alertas'
                ]
            },
            'ingresos': {
                summary: 'An√°lisis detallado de ingresos y facturaci√≥n',
                metrics: [
                    { label: 'Ingresos Hoy', value: '$45,230', change: '+15%' },
                    { label: 'Pagos Recibidos', value: '38', change: '+8%' },
                    { label: 'Pagos Pendientes', value: '12', change: '-3%' },
                    { label: 'Tasa Conversi√≥n', value: '94.2%', change: '+1.5%' }
                ],
                actions: [
                    'Ver todas las facturas',
                    'Generar reporte DGI',
                    'Configurar cobranzas'
                ]
            },
            'eficiencia': {
                summary: 'M√©tricas de eficiencia operativa del sistema',
                metrics: [
                    { label: 'Productividad', value: '94.5%', change: '+3.2%' },
                    { label: 'Tiempo Respuesta', value: '1.2s', change: '-0.3s' },
                    { label: 'Satisfacci√≥n', value: '4.8/5', change: '+0.2' },
                    { label: 'Disponibilidad', value: '99.8%', change: '+0.1%' }
                ],
                actions: [
                    'Ver m√©tricas detalladas',
                    'Configurar optimizaciones',
                    'Generar reporte ejecutivo'
                ]
            }
        };
        
        const content = detailedContent[kpiType] || detailedContent['retiros'];
        
        container.innerHTML = `
            <div style="padding: 1rem;">
                <p style="color: var(--text-secondary); margin-bottom: 2rem;">${content.summary}</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    ${content.metrics.map(metric => `
                        <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">${metric.label}</div>
                            <div style="font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">${metric.value}</div>
                            <div style="font-size: 0.8rem; color: var(--success-color);">${metric.change}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div>
                    <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Acciones Disponibles</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;" id="action-buttons">
                        <button onclick="downloadKPIReport('${kpiType}', 'csv')" style="padding: 0.5rem 1rem; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üìä Exportar CSV
                        </button>
                        <button onclick="downloadKPIReport('${kpiType}', 'pdf')" style="padding: 0.5rem 1rem; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üìÑ Exportar PDF
                        </button>
                        <button onclick="downloadKPIReport('${kpiType}', 'excel')" style="padding: 0.5rem 1rem; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üìà Exportar Excel
                        </button>
                        <button onclick="refreshKPIData('${kpiType}')" style="padding: 0.5rem 1rem; background: var(--accent2); color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üîÑ Actualizar
                        </button>
                    </div>
                </div>
                
                <div id="download-status" style="margin-top: 1rem; text-align: center; color: var(--text-secondary); display: none;">
                    <div style="padding: 1rem;">
                        <div style="animation: spin 1s linear infinite; margin: 0 auto 0.5rem; width: 20px; height: 20px; border: 2px solid var(--accent-color); border-top: 2px solid transparent; border-radius: 50%;"></div>
                        <div>Generando reporte...</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // ========================================
    // FUNCIONES DE DESCARGA Y EXPORTACI√ìN
    // ========================================
    
    function downloadKPIReport(kpiType, format) {
        console.log(`üì• Descargando reporte ${format.toUpperCase()} para ${kpiType}...`);
        
        // Mostrar estado de carga
        showDownloadStatus(true);
        
        // Simular procesamiento
        setTimeout(() => {
            try {
                const filename = `reporte-${kpiType}-${new Date().toISOString().split('T')[0]}.${format}`;
                
                switch(format) {
                    case 'csv':
                        downloadCSV(kpiType, filename);
                        break;
                    case 'pdf':
                        downloadPDF(kpiType, filename);
                        break;
                    case 'excel':
                        downloadExcel(kpiType, filename);
                        break;
                    default:
                        throw new Error('Formato no soportado');
                }
                
                console.log(`‚úÖ Reporte ${format.toUpperCase()} descargado: ${filename}`);
                showDownloadStatus(false);
                
                // Mostrar mensaje de √©xito
                showNotification(`Reporte ${format.toUpperCase()} descargado correctamente`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error al generar reporte:', error);
                showDownloadStatus(false);
                showNotification('Error al generar el reporte. Int√©ntalo de nuevo.', 'error');
            }
        }, 1500);
    }
    
    function downloadCSV(kpiType, filename) {
        // Datos de ejemplo - en producci√≥n vendr√≠an de Firebase
        const data = {
            'retiros': [
                ['Fecha', 'Cliente', 'Monto', 'Estado', 'Eficiencia'],
                ['2025-11-25', 'Juan P√©rez', '$5,000', 'Completado', '95%'],
                ['2025-11-25', 'Mar√≠a Garc√≠a', '$3,200', 'En proceso', '87%'],
                ['2025-11-24', 'Carlos L√≥pez', '$7,800', 'Completado', '92%']
            ],
            'ingresos': [
                ['Fecha', 'Concepto', 'Monto', 'M√©todo', 'Estado'],
                ['2025-11-25', 'Retiro #001', '$5,000', 'Transferencia', 'Confirmado'],
                ['2025-11-25', 'Retiro #002', '$3,200', 'Efectivo', 'Confirmado'],
                ['2025-11-24', 'Retiro #003', '$7,800', 'Transferencia', 'Confirmado']
            ],
            'eficiencia': [
                ['M√©trica', 'Valor Actual', 'Objetivo', 'Variaci√≥n'],
                ['Productividad', '94.5%', '95%', '+3.2%'],
                ['Tiempo Respuesta', '1.2s', '1.0s', '-0.3s'],
                ['Satisfacci√≥n', '4.8/5', '4.5/5', '+0.2'],
                ['Disponibilidad', '99.8%', '99.5%', '+0.1%']
            ]
        };
        
        const rows = data[kpiType] || data['retiros'];
        const csvContent = rows.map(row => row.map(field => `"${field}"`).join(',')).join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function downloadPDF(kpiType, filename) {
        // Para simplificar, generamos un HTML que el usuario puede imprimir como PDF
        const reportContent = `
<!DOCTYPE html>
<html>
<head>
    <title>Reporte ${kpiType}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        .header { text-align: center; margin-bottom: 2rem; }
        .metric { margin: 1rem 0; padding: 1rem; border: 1px solid #ddd; }
        .footer { margin-top: 2rem; text-align: center; color: #666; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Reporte Ejecutivo - ${kpiType.charAt(0).toUpperCase() + kpiType.slice(1)}</h1>
        <p>Generado el ${new Date().toLocaleDateString()}</p>
    </div>
    
    <div class="metric">
        <h3>M√©tricas Principales</h3>
        <p>‚Ä¢ Total registros: 147</p>
        <p>‚Ä¢ Completados: 132</p>
        <p>‚Ä¢ Eficiencia: 89.8%</p>
        <p>‚Ä¢ Variaci√≥n: +12%</p>
    </div>
    
    <div class="footer">
        <p>Gesti√≥n Sostenible - Dashboard Ejecutivo</p>
    </div>
</body>
</html>`;
        
        const blob = new Blob([reportContent], { type: 'text/html;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Mostrar mensaje para que el usuario imprima como PDF
        setTimeout(() => {
            showNotification('Archivo HTML generado. Usa Ctrl+P para guardar como PDF', 'info');
        }, 500);
    }
    
    function downloadExcel(kpiType, filename) {
        // Excel b√°sico usando CSV con extensi√≥n .xls
        const data = [
            ['Reporte Ejecutivo - ' + kpiType.charAt(0).toUpperCase() + kpiType.slice(1)],
            ['Generado el', new Date().toLocaleDateString()],
            [''],
            ['M√©trica', 'Valor', 'Variaci√≥n'],
            ['Total registros', '147', '+12%'],
            ['Completados', '132', '+8%'],
            ['Eficiencia', '89.8%', '+2.1%']
        ];
        
        const excelContent = data.map(row => row.join('\t')).join('\n');
        const blob = new Blob([excelContent], { type: 'application/vnd.ms-excel;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function refreshKPIData(kpiType) {
        console.log(`üîÑ Actualizando datos para ${kpiType}...`);
        showNotification('Actualizando datos...', 'info');
        
        // Simular actualizaci√≥n
        setTimeout(() => {
            loadAllKPIData();
            showNotification('Datos actualizados correctamente', 'success');
        }, 1000);
    }
    
    function showDownloadStatus(show) {
        const status = document.getElementById('download-status');
        if (status) {
            status.style.display = show ? 'block' : 'none';
        }
    }
    
    function showNotification(message, type = 'info') {
        // Crear notificaci√≥n temporal
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: ${type === 'success' ? 'var(--accent-color)' : type === 'error' ? '#f44336' : 'var(--accent2)'};
            color: white;
            border-radius: 8px;
            z-index: 10000;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Remover despu√©s de 3 segundos
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }
    
    // ========================================
    // AI INTELLIGENCE LAYER (MEJORADO)
    // ========================================

    const aiState = {
        loading: false,
        lastUpdated: null,
        predictions: {},
        recommendations: [],
        patterns: [],
        alerts: [],
        charts: {},
        clientModels: {},
        routeModels: {}
    };

    const aiConfig = {
        refreshMs: 45000,
        alertIntervalMs: 30000,
        patternIntervalMs: 60000
    };

    function initializeAIIntelligence() {
        console.log('ü§ñ Inicializando AI Intelligence Layer con modelos avanzados...');

        mapPredictionSlots();
        simulateRealtimeAnalysis();
        loadAIData();

        setInterval(loadAIData, aiConfig.refreshMs);
        setInterval(runPredictiveEngines, aiConfig.alertIntervalMs);
        setInterval(analyzePatterns, aiConfig.patternIntervalMs);
        setInterval(()=>{
            if(aiState.data){
                evaluateSmartAlerts(aiState.data);
            }
        }, aiConfig.alertIntervalMs);

        console.log('‚úÖ AI Intelligence Layer inicializado correctamente');
    }

    function mapPredictionSlots() {
        const grid = document.getElementById('predictionsGrid');
        if (!grid) return;

        const items = grid.querySelectorAll('.prediction-item');
        const mapping = ['retiros', 'ingresos', 'eficiencia'];
        items.forEach((item, index) => {
            const id = mapping[index];
            if (id) {
                item.dataset.prediction = id;
                ensurePredictionChart(item, id);
            }
        });
    }

    function ensurePredictionChart(item, id) {
        if (item.querySelector('canvas')) return;
        const canvas = document.createElement('canvas');
        canvas.width = 180;
        canvas.height = 48;
        canvas.className = 'prediction-chart';
        canvas.setAttribute('role', 'img');
        canvas.setAttribute('aria-label', `Tendencia proyectada para ${id}`);
        item.querySelector('.prediction-content').appendChild(canvas);
        aiState.charts[id] = canvas;
    }

    async function loadAIData() {
        if (aiState.loading) return;
        aiState.loading = true;
        const db = getDb();
        const orgId = (window.gsAuth && typeof gsAuth.getOrganizationId === 'function') ? gsAuth.getOrganizationId() : 'default';

        try {
            if (!db) {
                applyDemoAIData();
                return;
            }

            const today = todayYMD();
            const mes = currentMonth();

            const [clientesSnap, retirosSnap, pagosSnap] = await Promise.all([
                db.collection('clientes').where('organizationId','==',orgId).limit(500).get(),
                db.collection('retiros').where('organizationId','==',orgId).where('fecha','>=',today).limit(500).get(),
                db.collection('pagos').where('organizationId','==',orgId).where('mes','>=',mes).limit(500).get()
            ]);

            const clientes = clientesSnap.docs.map(doc=>({ id: doc.id, ...doc.data() }));
            const retiros = retirosSnap.docs.map(doc=>({ id: doc.id, ...doc.data() }));
            const pagos = pagosSnap.docs.map(doc=>({ id: doc.id, ...doc.data() }));

            aiState.data = { clientes, retiros, pagos };
            aiState.lastUpdated = Date.now();

            runPredictiveEngines();
        } catch (error) {
            console.error('‚ùå Error cargando datos de IA:', error);
            applyDemoAIData();
        } finally {
            aiState.loading = false;
        }
    }

    function applyDemoAIData() {
        if (gsAuth && typeof gsAuth.getDemoData === 'function') {
            const demo = gsAuth.getDemoData();
            aiState.data = {
                clientes: Array.isArray(demo?.clientes) ? demo.clientes : [],
                retiros: Array.isArray(demo?.retiros?.items) ? demo.retiros.items : [],
                pagos: Array.isArray(demo?.pagos?.items) ? demo.pagos.items : []
            };
            aiState.lastUpdated = Date.now();
            runPredictiveEngines();
        }
    }

    function runPredictiveEngines() {
        if (!aiState.data) return;

        const { clientes = [], retiros = [], pagos = [] } = aiState.data;
        const clientInsights = buildClientPredictiveModels(clientes, pagos);
        const routeInsights = buildRouteOptimizationModels(retiros, clientes);
        const financeInsights = buildFinancePredictions(pagos);

        aiState.predictions = {
            retiros: routeInsights?.demandForecast || {},
            ingresos: financeInsights?.revenue || {},
            eficiencia: routeInsights?.efficiency || {}
        };

        aiState.recommendations = buildAIRecommendations(clientInsights, routeInsights, financeInsights);
        aiState.patterns = [...(routeInsights?.patterns || []), ...(clientInsights?.patterns || [])].slice(0, 6);

        renderPredictions(aiState.predictions);
        updateRecommendationsDisplay(aiState.recommendations);
        updatePatternsDisplay(aiState.patterns);
        renderAIAlerts(clientInsights, routeInsights, financeInsights);
        evaluateSmartAlerts(aiState.data || {});
    }

    // ========================================
    // MODELOS AVANZADOS DE CLIENTES
    // ========================================

    function buildClientPredictiveModels(clientes = [], pagos = []) {
        const paymentHistoryByClient = pagos.reduce((acc, pago) => {
            const id = pago.clienteId || pago.cliente || pago.idCliente || 'desconocido';
            if (!acc[id]) acc[id] = [];
            acc[id].push(pago);
            return acc;
        }, {});

        const churnScores = clientes.map(cliente => ({
            id: cliente.id,
            nombre: cliente.nombre || 'Cliente',
            probabilidad: calculateChurnProbability(cliente, paymentHistoryByClient[cliente.id] || [])
        }));

        const clvScores = clientes.map(cliente => ({
            id: cliente.id,
            nombre: cliente.nombre || 'Cliente',
            valor: calculateCLV(cliente, paymentHistoryByClient[cliente.id] || [], churnScores)
        }));

        const upsellCandidates = detectUpsellOpportunities(clientes, paymentHistoryByClient);
        const paymentBehavior = analyzePaymentBehavior(pagos);
        const seasonality = detectSeasonalityPatterns(pagos);

        const churnAvg = average(churnScores.map(c=>c.probabilidad));
        const clvAvg = average(clvScores.map(c=>c.valor));

        const patterns = [
            { icon: 'üìâ', title: 'Riesgo de fuga', description: `${(churnAvg*100).toFixed(1)}% probabilidad media de churn`, impact: 'Activar retenci√≥n' },
            { icon: 'üíé', title: 'CLV promedio', description: `Valor de vida esperado $${Math.round(clvAvg).toLocaleString()}`, impact: 'Priorizar cuentas' },
            { icon: 'üõí', title: 'Upselling', description: `${upsellCandidates.length} clientes listos para upgrade`, impact: 'Campa√±a sugerida' }
        ];

        aiState.clientModels = { churnScores, clvScores, upsellCandidates, paymentBehavior, seasonality };
        return { churnScores, clvScores, upsellCandidates, paymentBehavior, seasonality, patterns };
    }

    function calculateChurnProbability(cliente, pagosCliente = []) {
        const today = new Date();
        const lastPaymentTs = pagosCliente.reduce((max,p)=>Math.max(max, p.fechaPago ? Date.parse(p.fechaPago) : (p.updatedAt || 0)), 0);
        const recencyDays = lastPaymentTs ? (today - lastPaymentTs) / (1000*60*60*24) : 90;
        const frequency = pagosCliente.length || 1;
        const avgTicket = average(pagosCliente.map(p=>toNumber(p.monto || p.importe || 0))) || 0;
        const tenureMonths = cliente.alta ? ((today - Date.parse(cliente.alta)) / (1000*60*60*24*30)) : 6;

        const normalizedRecency = Math.min(recencyDays / 120, 1);
        const normalizedFreq = Math.min(frequency / 12, 1);
        const normalizedTicket = Math.min(avgTicket / 15000, 1);
        const normalizedTenure = Math.min(tenureMonths / 24, 1);

        const score = (0.45 * normalizedRecency) - (0.25 * normalizedFreq) - (0.2 * normalizedTicket) - (0.1 * normalizedTenure);
        return Math.min(Math.max(1 / (1 + Math.exp(-6 * (score - 0.2))), 0), 1);
    }

    function calculateCLV(cliente, pagosCliente = [], churnScores = []) {
        const churnScore = churnScores.find(c=>c.id === cliente.id)?.probabilidad || 0.25;
        const revenueMonthly = average(pagosCliente.map(p=>toNumber(p.monto || p.importe || 0))) || toNumber(cliente.monto) || 0;
        const retention = 1 - churnScore;
        const horizonMonths = 12;
        return Math.max(revenueMonthly * horizonMonths * retention, 0);
    }

    function detectUpsellOpportunities(clientes = [], paymentHistoryByClient = {}) {
        return clientes.map(cliente => {
            const payments = paymentHistoryByClient[cliente.id] || [];
            const punctuality = calculateOnTimeRatio(payments);
            const spend = payments.reduce((sum,p)=>sum + toNumber(p.monto || p.importe || 0), 0);
            const frequency = payments.length;
            const score = (0.4 * punctuality) + (0.35 * Math.min(spend/50000,1)) + (0.25 * Math.min(frequency/10,1));
            return { id: cliente.id, nombre: cliente.nombre || 'Cliente', score, segmento: cliente.segmento || 'General' };
        }).filter(c=>c.score > 0.55);
    }

    function analyzePaymentBehavior(pagos = []) {
        const onTime = pagos.filter(p=> (p.estado || '').toLowerCase() === 'recibido').length;
        const total = pagos.length || 1;
        const ratio = onTime / total;
        const delays = pagos.map(p=> toNumber(p.diasRetraso || p.retraso || 0));
        const avgDelay = average(delays);
        return { onTimeRatio: ratio, avgDelay: avgDelay || 0, totalPagos: pagos.length };
    }

    function detectSeasonalityPatterns(pagos = []) {
        const byMonth = pagos.reduce((acc,p)=>{
            const mes = p.mes || (p.fechaPago ? (p.fechaPago + '').slice(0,7) : currentMonth());
            acc[mes] = (acc[mes] || 0) + toNumber(p.monto || p.importe || 0);
            return acc;
        },{});
        const entries = Object.entries(byMonth).sort();
        const values = entries.map(([,v])=>v);
        const trend = values.length > 1 ? (values[values.length-1] - values[0]) / Math.max(values[0],1) : 0;
        return { entries, trend };
    }

    // ========================================
    // MODELOS DE RUTEO Y DEMANDA
    // ========================================

    function buildRouteOptimizationModels(retiros = [], clientes = []) {
        const today = todayYMD();
        const todayRetiros = retiros.filter(r=> (r.fecha || r.dia || today) >= today);
        const optimized = optimizeRoutes(todayRetiros);
        const demandForecast = predictZoneDemand(todayRetiros);
        const efficiency = estimateEfficiency(todayRetiros, optimized);
        const patterns = deriveRoutePatterns(todayRetiros);

        aiState.routeModels = { optimized, demandForecast, efficiency };
        return { optimized, demandForecast, efficiency, patterns };
    }

    function optimizeRoutes(retiros = []) {
        const grouped = retiros.reduce((acc, r) => {
            const zone = r.zona || r.sector || 'General';
            if (!acc[zone]) acc[zone] = [];
            acc[zone].push(r);
            return acc;
        }, {});

        return Object.entries(grouped).map(([zone, items]) => {
            const ordered = nearestNeighborOrder(items);
            const total = ordered.reduce((sum,item) => sum + toNumber(item.distancia || item.km || 3), 0);
            return { zone, stops: ordered.length, distance: total, ordered };
        });
    }

    function nearestNeighborOrder(items = []) {
        const remaining = [...items];
        const route = [];
        let current = remaining.shift();
        if (current) route.push(current);

        while (remaining.length) {
            const nextIndex = remaining.reduce((bestIdx, candidate, idx) => {
                const best = remaining[bestIdx] || current;
                const currentDistance = estimateDistance(current, candidate);
                const bestDistance = estimateDistance(current, best);
                return currentDistance < bestDistance ? idx : bestIdx;
            }, 0);
            current = remaining.splice(nextIndex,1)[0];
            route.push(current);
        }
        return route;
    }

    function estimateDistance(a = {}, b = {}) {
        const distA = toNumber(a.distancia || a.km || Math.random()*5+1);
        const distB = toNumber(b.distancia || b.km || Math.random()*5+1);
        return Math.abs(distA - distB) + 1;
    }

    function predictZoneDemand(retiros = []) {
        const byZone = retiros.reduce((acc,r)=>{
            const zone = r.zona || r.sector || 'General';
            acc[zone] = (acc[zone] || 0) + 1;
            return acc;
        },{});
        const baseline = average(Object.values(byZone)) || 0;
        return Object.entries(byZone).map(([zone,count])=>({
            zone,
            expected: Math.round(count * 1.08),
            growth: baseline ? ((count - baseline)/baseline) * 100 : 0
        }));
    }

    function estimateEfficiency(retiros = [], optimized = []) {
        const planned = retiros.length;
        const optimizedStops = optimized.reduce((sum,r)=>sum + (r.stops || 0), 0);
        const kmOriginal = retiros.reduce((sum,r)=>sum + toNumber(r.km || r.distancia || 3),0);
        const kmOptimized = optimized.reduce((sum,r)=>sum + toNumber(r.distance || 0),0) || kmOriginal;
        const savings = kmOriginal ? ((kmOriginal - kmOptimized) / kmOriginal) * 100 : 0;
        const timePrediction = predictDeliveryTimes(retiros);
        return { planned, optimizedStops, savings, timePrediction };
    }

    function predictDeliveryTimes(retiros = []) {
        const base = 12;
        const variable = average(retiros.map(r=> toNumber(r.duracion || r.tiempo || 18))) || 18;
        return {
            averageMinutes: base + variable,
            windowRecommendation: variable > 20 ? 'Usar ventanas de 90 minutos' : 'Ventanas de 60 minutos',
            confidence: 0.8
        };
    }

    function deriveRoutePatterns(retiros = []) {
        if (!retiros.length) return [];
        const morningShare = retiros.filter(r=> (r.hora || '').startsWith('0') || (r.hora || '').startsWith('1')).length / retiros.length;
        return [
            { icon: 'üó∫Ô∏è', title: 'Optimizaci√≥n rutas', description: 'Aplicar vecino m√°s cercano por zona', impact: 'Menor kilometraje' },
            { icon: '‚è±Ô∏è', title: 'Ventanas sugeridas', description: '60-90 minutos seg√∫n densidad', impact: 'SLA estable' },
            { icon: 'üåÖ', title: 'Preferencia ma√±anas', description: `${Math.round(morningShare*100)}% retiros en la ma√±ana`, impact: 'Asignar flota temprano' }
        ];
    }

    // ========================================
    // PREDICCIONES FINANCIERAS SIMPLIFICADAS
    // ========================================

    function buildFinancePredictions(pagos = []) {
        const total = pagos.reduce((sum,p)=> sum + toNumber(p.monto || p.importe || 0), 0);
        const growth = pagos.slice(-7).reduce((sum,p)=> sum + toNumber(p.monto || 0),0);
        const trend = total ? (growth / total) * 100 : 0;
        const confidence = Math.min(70 + (pagos.length * 0.3), 95);

        return {
            revenue: {
                value: total,
                trend,
                confidence,
                sparkline: pagos.map(p=> toNumber(p.monto || p.importe || 0)).slice(-12)
            },
            metrics: {
                margin: 0.22 + Math.random()*0.05,
                collectionRate: calculateOnTimeRatio(pagos),
                forecast30d: total * (1 + (trend/100))
            }
        };
    }

    // ========================================
    // RENDER / ALERTAS / RECOMENDACIONES
    // ========================================

    function renderPredictions(predictions = {}) {
        const defaultData = {
            retiros: { value: 0, trend: 0, confidence: 0, sparkline: [] },
            ingresos: { value: 0, trend: 0, confidence: 0, sparkline: [] },
            eficiencia: { value: 0, trend: 0, confidence: 0, sparkline: [] }
        };

        const merged = { ...defaultData, ...predictions };
        Object.entries(merged).forEach(([id, data]) => {
            const element = document.querySelector(`[data-prediction="${id}"]`);
            if (!element) return;

            const valueEl = element.querySelector('.prediction-value');
            const trendEl = element.querySelector('.prediction-trend');
            const confEl = element.querySelector('.prediction-confidence');

            const safeValue = Number.isFinite(toNumber(data?.value)) ? toNumber(data.value) : 0;
            const safeTrend = Number.isFinite(toNumber(data?.trend)) ? toNumber(data.trend) : 0;
            const safeConfidence = Number.isFinite(toNumber(data?.confidence)) ? toNumber(data.confidence) : 0;
            const spark = Array.isArray(data?.sparkline) ? data.sparkline.map((v)=> toNumber(v) || 0) : [];

            if (valueEl) {
                const formatted = id === 'ingresos'
                  ? `$${Math.round(safeValue).toLocaleString()}`
                  : `${safeValue.toFixed(1)}${id === 'eficiencia' ? '%' : ''}`;
                valueEl.innerHTML = `${formatted} <span class="prediction-trend ${safeTrend >= 0 ? 'up' : 'down'}">${safeTrend >= 0 ? '+' : ''}${safeTrend.toFixed(1)}%</span>`;
            }
            if (trendEl) {
                trendEl.textContent = `${safeTrend >= 0 ? '+' : ''}${safeTrend.toFixed(1)}%`;
                trendEl.className = `prediction-trend ${safeTrend >= 0 ? 'up' : 'down'}`;
            }
            if (confEl) {
                confEl.textContent = `Confianza: ${safeConfidence.toFixed(0)}%`;
            }

            if (aiState.charts[id]) {
                drawSparkline(aiState.charts[id], spark);
            }
        });
    }

    function drawSparkline(canvas, values = []) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if (!values.length) return;
        const max = Math.max(...values);
        const min = Math.min(...values);
        const range = max - min || 1;
        const step = canvas.width / Math.max(values.length-1, 1);
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#1DBF73';
        ctx.lineWidth = 2;
        ctx.beginPath();
        values.forEach((v, idx) => {
            const x = idx * step;
            const y = canvas.height - ((v - min) / range) * canvas.height;
            if (idx === 0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
    }

    function updateRecommendationsDisplay(recommendations = []) {
        const container = document.getElementById('recommendationsList');
        if (!container) return;

        container.innerHTML = recommendations.map(rec => `
            <div class="recommendation-item priority-${rec.priority}">
                <div class="rec-priority">${rec.priority === 'high' ? 'Alto' : rec.priority === 'medium' ? 'Medio' : 'Bajo'}</div>
                <div class="rec-content">
                    <div class="rec-title">${rec.title}</div>
                    <div class="rec-description">${rec.description}</div>
                    <div class="rec-actions">
                        <button class="rec-btn primary" onclick="implementRecommendation('${rec.id}')">${rec.action || 'Implementar'}</button>
                        <button class="rec-btn secondary" onclick="viewRecommendationDetails('${rec.id}')">Detalles</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function buildAIRecommendations(clientInsights, routeInsights, financeInsights) {
        const recs = [];

        const highChurn = clientInsights.churnScores?.filter(c=>c.probabilidad > 0.55).slice(0,3) || [];
        if (highChurn.length) {
            recs.push({
                id: 'retencion_clientes',
                title: 'Campa√±a de retenci√≥n prioritaria',
                description: `Contactar a ${highChurn.length} clientes con alto riesgo de fuga y ofrecer upgrade/bonificaci√≥n`,
                priority: 'high',
                action: 'Lanzar campa√±a'
            });
        }

        const topUpsell = clientInsights.upsellCandidates?.slice(0,3) || [];
        if (topUpsell.length) {
            recs.push({
                id: 'upsell',
                title: 'Upsell en clientes cumplidores',
                description: `${topUpsell.length} cuentas con alto score de upgrade y pagos puntuales`,
                priority: 'medium',
                action: 'Enviar oferta'
            });
        }

        if (routeInsights.savings > 5) {
            recs.push({
                id: 'optimize_routes',
                title: 'Optimizar rutas por zona',
                description: `Ahorro estimado ${routeInsights.savings.toFixed(1)}% en km planificados aplicando vecino m√°s cercano`,
                priority: 'high',
                action: 'Optimizar'
            });
        }

        if (financeInsights.metrics?.collectionRate < 0.8) {
            recs.push({
                id: 'mejorar_cobranzas',
                title: 'Refuerzo de cobranzas',
                description: `Tasa de cobro ${(financeInsights.metrics.collectionRate*100).toFixed(1)}%. Activar recordatorios y cobranza proactiva`,
                priority: 'medium',
                action: 'Automatizar avisos'
            });
        }

        return recs.length ? recs : [{
            id: 'health_check',
            title: 'Todo en verde',
            description: 'No se detectaron riesgos cr√≠ticos. Mantener monitoreo.',
            priority: 'low',
            action: 'Revisar'
        }];
    }

    function updatePatternsDisplay(patterns = []) {
        const container = document.getElementById('patternsGrid');
        if (!container) return;

        container.innerHTML = patterns.map(pattern => `
            <div class="pattern-item">
                <div class="pattern-icon">${pattern.icon}</div>
                <div class="pattern-content">
                    <div class="pattern-title">${pattern.title}</div>
                    <div class="pattern-description">${pattern.description}</div>
                    <div class="pattern-impact">${pattern.impact || ''}</div>
                </div>
            </div>
        `).join('');
    }

    function analyzePatterns() {
        if (!aiState.data) return;
        const newPatterns = deriveRoutePatterns(aiState.data.retiros || []);
        updatePatternsDisplay(newPatterns);
    }

    function renderAIAlerts(clientInsights, routeInsights, financeInsights) {
        const alerts = [];
        const churnHigh = clientInsights.churnScores?.filter(c=>c.probabilidad > 0.7).length || 0;
        if (churnHigh) {
            alerts.push({ level: 'critical', message: `${churnHigh} clientes con probabilidad de churn > 70%`, type:'churn' });
        }

        if ((routeInsights.savings || 0) < 0) {
            alerts.push({ level: 'warning', message: 'Se detecta aumento de kilometraje planificado', type:'ruta' });
        }

        if ((financeInsights.metrics?.collectionRate || 1) < 0.75) {
            alerts.push({ level: 'warning', message: 'Ca√≠da en tasa de cobranzas. Revisar recordatorios.', type:'finanzas' });
        }

        aiState.alerts = alerts;
        const alertsContainer = document.getElementById('alertsContent');
        if (!alertsContainer) return;
        alertsContainer.innerHTML = alerts.map(alert => `
            <div class="alert ${alert.level}" data-type="${alert.type||'general'}">${alert.message}</div>
        `).join('');
    }

    function evaluateSmartAlerts(data = {}) {
        const alertsContainer = document.getElementById('alertsContent');
        const notifications = [];
        const now = Date.now();
        const pagos = Array.isArray(data.pagos) ? data.pagos : [];
        const clientes = Array.isArray(data.clientes) ? data.clientes : [];
        const retiros = Array.isArray(data.retiros) ? data.retiros : [];

        const anomalousPayments = pagos.filter(p=>{
            const amount = toNumber(p.monto || p.importe || 0);
            const isLate = (p.estado || '').toLowerCase() === 'pendiente';
            return amount > 20000 || isLate;
        });
        if(anomalousPayments.length){
            notifications.push({ level: 'critical', title: 'Patr√≥n de pagos an√≥malo', message: `${anomalousPayments.length} movimientos requieren revisi√≥n.` });
        }

        const inactiveClients = clientes.filter(c=>{
            const lastUpdate = c.updatedAt ? Date.parse(c.updatedAt) : 0;
            return !c.contrato && (!lastUpdate || (now - lastUpdate) > (45*24*60*60*1000));
        });
        if(inactiveClients.length){
            notifications.push({ level: 'high', title: 'Clientes inactivos', message: `${inactiveClients.length} cuentas sin actividad reciente.` });
        }

        const routeIneff = retiros.filter(r=> toNumber(r.km || r.distancia || 0) > 25);
        if(routeIneff.length){
            notifications.push({ level: 'medium', title: 'Rutas ineficientes', message: `${routeIneff.length} retiros superan 25km estimados.` });
        }

        const operationalIssues = retiros.filter(r=> (r.estado || '').toLowerCase() === 'demorado').length;
        if(operationalIssues){
            notifications.push({ level: 'high', title: 'Demoras operativas', message: `${operationalIssues} retiros demorados.` });
        }

        const upsellCandidates = (aiState.clientModels?.upsellCandidates || []).length;
        if(upsellCandidates){
            notifications.push({ level: 'low', title: 'Oportunidad de negocio', message: `${upsellCandidates} clientes listos para upsell.` });
        }

        aiState.alerts = [...(aiState.alerts || []), ...notifications].slice(-10);
        if(alertsContainer){
            const existing = alertsContainer.innerHTML;
            const newHtml = notifications.map(alert=>`<div class="alert ${alert.level}" data-type="smart">${alert.title}: ${alert.message}</div>`).join('');
            alertsContainer.innerHTML = newHtml + existing;
        }
        notifications.forEach(alert=>{
            pushWebNotification(alert.title, alert.message, alert.level);
            if(alert.level === 'low'){
                setTimeout(()=> autoResolveAlert(alert.title), 15000);
            }
        });
    }

    function pushWebNotification(title, body, level='info'){
        if(!('Notification' in window)) return;
        if(Notification.permission === 'granted'){
            new Notification(`AI ${level.toUpperCase()}: ${title}`, { body });
        }else if(Notification.permission !== 'denied'){
            Notification.requestPermission().then(permission=>{
                if(permission === 'granted'){
                    new Notification(`AI ${level.toUpperCase()}: ${title}`, { body });
                }
            });
        }
    }

    function autoResolveAlert(title){
        const alertsContainer = document.getElementById('alertsContent');
        if(!alertsContainer) return;
        const nodes = alertsContainer.querySelectorAll('.alert');
        nodes.forEach(node=>{
            if(node.textContent && node.textContent.includes(title)){
                node.classList.add('resolved');
                node.setAttribute('aria-label','Alerta resuelta autom√°ticamente');
            }
        });
    }

    function simulateRealtimeAnalysis() {
        const statusElement = document.getElementById('aiStatus');
        if (statusElement) {
            setInterval(() => {
                const dot = statusElement.querySelector('.status-dot');
                if (dot) {
                    dot.classList.toggle('active');
                }
            }, 2000);
        }
    }

    // ========================================
    // ACCIONES Y REPORTES
    // ========================================

    function implementRecommendation(recommendationId) {
        console.log(`üîß Implementando recomendaci√≥n: ${recommendationId}`);

        const messages = {
            'optimize_routes': 'Rutas optimizadas y reasignadas. Mejora estimada aplicada.',
            'adjust_schedule': 'Horarios ajustados autom√°ticamente. Nuevas preferencias aplicadas',
            'maintenance': 'Mantenimiento programado para veh√≠culo #7 en 3 d√≠as',
            'retencion_clientes': 'Se activaron secuencias de retenci√≥n para cuentas cr√≠ticas',
            'upsell': 'Se envi√≥ campa√±a de upsell a clientes elegibles',
            'mejorar_cobranzas': 'Recordatorios de cobranza activados'
        };

        showNotification(messages[recommendationId] || 'Recomendaci√≥n implementada', 'success');

        setTimeout(() => {
            if (recommendationId === 'optimize_routes') {
                updateKPIValue('eficiencia', `${(90 + Math.random()*5).toFixed(1)}%`);
            }
        }, 1500);
    }

    function viewRecommendationDetails(recommendationId) {
        const details = {
            'optimize_routes': {
                title: 'Detalles: Optimizaci√≥n de Rutas',
                content: `
                    <strong>Modelo aplicado:</strong> Heur√≠stica de vecino m√°s cercano + balanceo zonal<br>
                    <strong>Ahorro estimado:</strong> ${aiState.routeModels?.efficiency?.savings?.toFixed ? aiState.routeModels.efficiency.savings.toFixed(1) : 8.5}% de km<br>
                    <strong>Balance choferes:</strong> ${aiState.routeModels?.optimized?.length || 0} zonas redistribuidas
                `
            },
            'adjust_schedule': {
                title: 'Detalles: Ajuste Horarios',
                content: `
                    <strong>Ventanas recomendadas:</strong> ${aiState.routeModels?.efficiency?.timePrediction?.windowRecommendation || '60-90 minutos'}<br>
                    <strong>Confianza:</strong> ${(aiState.routeModels?.efficiency?.timePrediction?.confidence || 0.8)*100}%<br>
                    <strong>Demanda por zona:</strong> ${JSON.stringify(aiState.routeModels?.demandForecast || [])}
                `
            },
            'maintenance': {
                title: 'Detalles: Mantenimiento Preventivo',
                content: `
                    <strong>Reglas predictivas:</strong> Umbrales por km y uso hist√≥rico.<br>
                    <strong>Beneficio:</strong> Previene paradas imprevistas y mantiene SLA.
                `
            },
            'retencion_clientes': {
                title: 'Detalles: Retenci√≥n de Clientes',
                content: `
                    <strong>Clientes cr√≠ticos:</strong> ${aiState.clientModels?.churnScores?.filter(c=>c.probabilidad>0.7).length || 0}<br>
                    <strong>Acciones:</strong> Descuentos temporales, contacto proactivo, plan fidelizaci√≥n.
                `
            },
            'upsell': {
                title: 'Detalles: Upsell Inteligente',
                content: `
                    <strong>Candidatos:</strong> ${aiState.clientModels?.upsellCandidates?.length || 0}<br>
                    <strong>Segmentos:</strong> ${[...(aiState.clientModels?.upsellCandidates || []).map(c=>c.segmento)].slice(0,3).join(', ')}
                `
            },
            'mejorar_cobranzas': {
                title: 'Detalles: Mejorar Cobranzas',
                content: `
                    <strong>Tasa de cobro actual:</strong> ${(aiState.clientModels?.paymentBehavior?.onTimeRatio || 0)*100}%<br>
                    <strong>Retraso promedio:</strong> ${(aiState.clientModels?.paymentBehavior?.avgDelay || 0).toFixed(1)} d√≠as<br>
                    <strong>Plan:</strong> Recordatorios autom√°ticos + escalamiento a control.
                `
            }
        };

        const detail = details[recommendationId];
        if (detail) {
            const modal = createDetailModal(detail.title, detail.content);
            document.body.appendChild(modal);
        }
    }

    function createDetailModal(title, content) {
        const modal = document.createElement('div');
        modal.className = 'drilldown-modal';
        modal.innerHTML = `
            <div class="drilldown-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                <div class="drilldown-header">
                    <h2>${title}</h2>
                    <button class="close-modal" onclick="this.closest('.drilldown-modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">&times;</button>
                </div>
                <div class="drilldown-body" style="padding: 1.5rem; line-height: 1.6;">
                    ${content}
                </div>
                <div class="drilldown-actions" style="padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); display:flex; gap: 1rem; justify-content: flex-end;">
                    <button class="rec-btn secondary" onclick="this.closest('.drilldown-modal').remove()">Cerrar</button>
                    <button class="rec-btn primary" onclick="generateAIReport('${title}')">Generar Reporte IA</button>
                </div>
            </div>
        `;

        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });

        return modal;
    }

    function generateAIReport(reportTitle) {
        showNotification('Generando reporte detallado con IA...', 'info');

        setTimeout(() => {
            generateReportContent(reportTitle);
            downloadKPIReport('ai-analysis', 'pdf');
            showNotification('Reporte de an√°lisis IA generado', 'success');
        }, 1200);
    }

    function generateReportContent(title) {
        return {
            title: title,
            timestamp: new Date().toLocaleString(),
            content: 'Reporte completo generado por AI Intelligence Layer'
        };
    }

    function updateKPIValue(kpiType, newValue) {
        const kpiElement = document.querySelector(`[data-kpi="${kpiType}"] .kpi-value`);
        if (kpiElement) {
            kpiElement.textContent = newValue;
            kpiElement.style.transform = 'scale(1.1)';
            setTimeout(() => { kpiElement.style.transform = 'scale(1)'; }, 300);
        }
    }

    // ========================================
    // UTILIDADES DE M√âTRICAS
    // ========================================

    function calculateOnTimeRatio(pagos = []) {
        if (!pagos.length) return 0;
        const onTime = pagos.filter(p=> (p.estado || '').toLowerCase() === 'recibido').length;
        return onTime / pagos.length;
    }

    function average(arr = []) {
        if (!arr.length) return 0;
        return arr.reduce((sum,v)=>sum + (Number(v) || 0),0) / arr.length;
    }

    // ========================================
    // PERFORMANCE, PWA Y UX
    // ========================================

    function prefetchModulePage(page){
      try{
        fetch(page, { method: 'GET', cache: 'force-cache' }).catch(()=>{});
      }catch(err){ /* sin efecto */ }
    }

    function warmupModules(){
      const pages = ['clientes-firestore.html','finanzas.html','retiros.html','usuarios.html','configuracion.html'];
      if('requestIdleCallback' in window){
        requestIdleCallback(()=> pages.forEach(prefetchModulePage), { timeout: 1500 });
      }else{
        setTimeout(()=> pages.forEach(prefetchModulePage), 1200);
      }
    }

    function registerGsServiceWorker(){
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('sw.js').catch(()=>{});
      }
    }

    function applyThemeToggle(){
      const saved = localStorage.getItem('gs:theme:mode');
      if(saved){ document.documentElement.setAttribute('data-theme', saved); }
      const style = document.createElement('style');
      style.textContent = `#themeToggle{position:fixed;bottom:18px;right:18px;z-index:50;background:var(--gs-accent,#1DBF73);color:#fff;border:none;padding:10px 12px;border-radius:12px;box-shadow:0 8px 20px rgba(13,43,61,.18);cursor:pointer;font-weight:700}#themeToggle:hover{transform:translateY(-1px)}[data-theme="dark"] body{background:#0d1a24;color:#e8f0f7;filter:invert(0.92) hue-rotate(180deg);} [data-theme="dark"] img,[data-theme="dark"] video,[data-theme="dark"] canvas{filter:invert(0.92) hue-rotate(180deg);} `;
      document.head.appendChild(style);
      const btn = document.createElement('button');
      btn.id = 'themeToggle';
      btn.type = 'button';
      btn.textContent = 'üåó Tema';
      btn.addEventListener('click', ()=>{
        const current = document.documentElement.getAttribute('data-theme') || 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('gs:theme:mode', next);
      });
      document.body.appendChild(btn);
    }

    function attachGlobalLoadingStates(){
      document.body.addEventListener('click', (e)=>{
        const target = e.target;
        if(target && target.matches('[data-loading-text]')){
          const original = target.textContent;
          target.dataset.originalText = original;
          target.textContent = target.getAttribute('data-loading-text');
          setTimeout(()=>{ target.textContent = target.dataset.originalText || original; }, 1200);
        }
      });
    }

    // Inicializar modal cuando el DOM est√© listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupDrilldownModal);
    } else {
        setupDrilldownModal();
    }

    warmupModules();
    registerGsServiceWorker();
    applyThemeToggle();
    attachGlobalLoadingStates();
    applyNavPermissions();
  </script>
  <!-- SVG Icons para Executive Command Center -->
  <svg width="0" height="0" class="sr-only">
    <symbol id="icon-refresh" viewBox="0 0 24 24">
      <path fill="currentColor" d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
    </symbol>
    <symbol id="icon-trending-up" viewBox="0 0 24 24">
      <path fill="currentColor" d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
    </symbol>
    <symbol id="icon-trending-down" viewBox="0 0 24 24">
      <path fill="currentColor" d="M16 18l2.29-2.29-4.88-4.88-4 4L2 7.41 3.41 6l6 6 4-4-6.3-6.29L22 12v6z"/>
    </symbol>
    <symbol id="icon-alert" viewBox="0 0 24 24">
      <path fill="currentColor" d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
    </symbol>
  </svg>

</body>
</html>



